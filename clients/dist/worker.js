!function(t){self.webpackChunk=function(e,r){for(var n in r)t[n]=r[n];for(;e.length;)i[e.pop()]=1};var e={},i={0:1};function r(i){if(e[i])return e[i].exports;var n=e[i]={i:i,l:!1,exports:{}};return t[i].call(n.exports,n,n.exports,r),n.l=!0,n.exports}r.e=function(t){var e=[];return e.push(Promise.resolve().then((function(){i[t]||importScripts(r.p+""+t+".worker.js")}))),Promise.all(e)},r.m=t,r.c=e,r.d=function(t,e,i){r.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},r.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(r.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)r.d(i,n,function(e){return t[e]}.bind(null,n));return i},r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="",r(r.s=22)}([function(t,e,i){t.exports={...i(7),...i(4),...i(15),...i(17)}},function(t,e,i){const{createResponseType:r}=i(11),n=r("application/json; charset=utf-8");t.exports={json:n}},function(t,e){t.exports={Router:function({base:t="",routes:e=[]}={}){return{__proto__:new Proxy({},{get:(i,r,n)=>(i,...o)=>e.push([r.toUpperCase(),RegExp(`^${(t+i).replace(/(\/?)\*/g,"($1.*)?").replace(/\/$/,"").replace(/:(\w+)(\?)?(\.)?/g,"$2(?<$1>[^/]+)$2$3").replace(/\.(?=[\w(])/,"\\.").replace(/\)\.\?\(([^\[]+)\[\^/g,"?)\\.?($1(?<=\\.)[^\\.")}/*$`),o])&&n}),routes:e,async handle(t,...i){let r,n,o=new URL(t.url);for(var[s,a,l]of(t.query=Object.fromEntries(o.searchParams),e))if((s===t.method||"ALL"===s)&&(n=o.pathname.match(a)))for(var c of(t.params=n.groups,l))if(void 0!==(r=await c(t.proxy||t,...i)))return r}}}}},function(t,e,i){"use strict";if(Object.defineProperty(e,"__esModule",{value:!0}),e.decode=e.verify=e.sign=void 0,"undefined"==typeof crypto||!crypto.subtle)throw new Error("SubtleCrypto not supported!");function r(t){return new Uint8Array(Array.prototype.map.call(atob(t.replace(/-/g,"+").replace(/_/g,"/").replace(/\s/g,"")),t=>t.charCodeAt(0)))}function n(t){return btoa(String.fromCharCode.apply(0,t)).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}const o={ES256:{name:"ECDSA",namedCurve:"P-256",hash:{name:"SHA-256"}},ES384:{name:"ECDSA",namedCurve:"P-384",hash:{name:"SHA-384"}},ES512:{name:"ECDSA",namedCurve:"P-521",hash:{name:"SHA-512"}},HS256:{name:"HMAC",hash:{name:"SHA-256"}},HS384:{name:"HMAC",hash:{name:"SHA-384"}},HS512:{name:"HMAC",hash:{name:"SHA-512"}},RS256:{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},RS384:{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-384"}},RS512:{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-512"}}};function s(t){return r(btoa(unescape(encodeURIComponent(t))))}function a(t){t=atob(t);const e=new ArrayBuffer(t.length),i=new Uint8Array(e);for(let e=0,r=t.length;e<r;e++)i[e]=t.charCodeAt(e);return e}function l(t){switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw new Error("Illegal base64url string!")}try{return JSON.parse(decodeURIComponent(escape(atob(t))))}catch{return null}}async function c(t,e,i={algorithm:"HS256",header:{typ:"JWT"}}){if("string"==typeof i&&(i={algorithm:i,header:{typ:"JWT"}}),i={algorithm:"HS256",header:{typ:"JWT"},...i},null===t||"object"!=typeof t)throw new Error("payload must be an object");if("string"!=typeof e)throw new Error("secret must be a string");if("string"!=typeof i.algorithm)throw new Error("options.algorithm must be a string");const r=o[i.algorithm];if(!r)throw new Error("algorithm not found");t.iat=Math.floor(Date.now()/1e3);const l=JSON.stringify(t),c=`${n(s(JSON.stringify({...i.header,alg:i.algorithm})))}.${n(s(l))}`;let h,u="raw";e.startsWith("-----BEGIN")?(u="pkcs8",h=a(e.replace(/-----BEGIN.*?-----/g,"").replace(/-----END.*?-----/g,"").replace(/\s/g,""))):h=s(e);const p=await crypto.subtle.importKey(u,h,r,!1,["sign"]),d=await crypto.subtle.sign(r,p,s(c));return`${c}.${n(new Uint8Array(d))}`}async function h(t,e,i={algorithm:"HS256",throwError:!1}){if("string"==typeof i&&(i={algorithm:i,throwError:!1}),i={algorithm:"HS256",throwError:!1,...i},"string"!=typeof t)throw new Error("token must be a string");if("string"!=typeof e)throw new Error("secret must be a string");if("string"!=typeof i.algorithm)throw new Error("options.algorithm must be a string");const n=t.split(".");if(3!==n.length)throw new Error("token must consist of 3 parts");const l=o[i.algorithm];if(!l)throw new Error("algorithm not found");const{payload:c}=u(t);if(!c){if(i.throwError)throw"PARSE_ERROR";return!1}if(c.nbf&&c.nbf>Math.floor(Date.now()/1e3)){if(i.throwError)throw"NOT_YET_VALID";return!1}if(c.exp&&c.exp<=Math.floor(Date.now()/1e3)){if(i.throwError)throw"EXPIRED";return!1}let h,p="raw";e.startsWith("-----BEGIN")?(p="spki",h=a(e.replace(/-----BEGIN.*?-----/g,"").replace(/-----END.*?-----/g,"").replace(/\s/g,""))):h=s(e);const d=await crypto.subtle.importKey(p,h,l,!1,["verify"]);return await crypto.subtle.verify(l,d,r(n[2]),s(`${n[0]}.${n[1]}`))}function u(t){return{header:l(t.split(".")[0].replace(/-/g,"+").replace(/_/g,"/")),payload:l(t.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"))}}e.sign=c,e.verify=h,e.decode=u,e.default={sign:c,verify:h,decode:u}},function(t,e,i){t.exports={...i(5),...i(1),...i(12),...i(13),...i(14)}},function(t,e,i){const{json:r}=i(1);t.exports={error:(t=500,e="Internal Server Error.")=>r({..."object"==typeof e?e:{status:t,error:e}},{status:t})}},function(t,e,i){(function(r,n){var o,s,a;s=[],void 0===(a="function"==typeof(o=function(){return function(){"use strict";var t=Object.prototype.hasOwnProperty;function e(t){var i,r;if(Array.isArray(t)){for(r=0;r<t.length;r++)e(t[r]);o(t)}else if(null!==t&&"object"==typeof t){for(i in t)t.hasOwnProperty(i)&&e(t[i]);o(t)}}function o(t){Object.isFrozen(t)||Object.freeze(t)}function s(t){return Object.isFrozen(t)?m(t,"shallow"):t}var a={copyProperties:function(t,e){var i;for(i in t)e[i]=t[i]},resolveTransformObject:function(t,e,i){var r,n;if("number"!=typeof i&&(i=0),++i>=10)return t;for(r in t)"string"==typeof t[r]&&0===t[r].indexOf("[%lktxp]")?(n=t[r].substring(8),e.hasOwnProperty(n)&&(t[r]=e[n])):"object"==typeof t[r]&&(t[r]=a.resolveTransformObject(t[r],e,i));return t},resolveTransformParams:function(t,e){var i,r,n=[];if(void 0===e)return t;for(i=0;i<t.length;i++)r=m(t[i],"shallow-recurse-objects"),n.push(a.resolveTransformObject(r,e));return n},getIn:function(t,e,i){if(null!=t){if(!i)return t[e];if("string"==typeof e&&(e=e.split(".")),!Array.isArray(e))throw new Error("path must be a string or array. Found "+typeof e);for(var r=0,n=e.length;null!=t&&r<n;)t=t[e[r++]];return r&&r==n?t:void 0}}},l={aeq:c,lt:h,gt:u};function c(t,e){var i,r,n,o;if(t===e)return!0;if(!t||!e||!0===t||!0===e||t!=t||e!=e){switch(t){case void 0:case null:n=1;break;case!1:n=3;break;case!0:n=4;break;case"":n=5;break;default:n=t==t?9:0}switch(e){case void 0:case null:o=1;break;case!1:o=3;break;case!0:o=4;break;case"":o=5;break;default:o=e==e?9:0}if(9!==n||9!==o)return n===o}return i=Number(t),r=Number(e),i==i||r==r?i===r:(i=t.toString())==(r=e.toString())}function h(t,e,i){var r,n,o,s;if(!t||!e||!0===t||!0===e||t!=t||e!=e){switch(t){case void 0:case null:o=1;break;case!1:o=3;break;case!0:o=4;break;case"":o=5;break;default:o=t==t?9:0}switch(e){case void 0:case null:s=1;break;case!1:s=3;break;case!0:s=4;break;case"":s=5;break;default:s=e==e?9:0}if(9!==o||9!==s)return o===s?i:o<s}return r=Number(t),n=Number(e),r==r&&n==n?r<n||!(r>n)&&i:r==r&&n!=n||(n!=n||r==r)&&(t<e||!(t>e)&&(t==e?i:(r=t.toString())<(n=e.toString())||r==n&&i))}function u(t,e,i){var r,n,o,s;if(!t||!e||!0===t||!0===e||t!=t||e!=e){switch(t){case void 0:case null:o=1;break;case!1:o=3;break;case!0:o=4;break;case"":o=5;break;default:o=t==t?9:0}switch(e){case void 0:case null:s=1;break;case!1:s=3;break;case!0:s=4;break;case"":s=5;break;default:s=e==e?9:0}if(9!==o||9!==s)return o===s?i:o>s}return r=Number(t),n=Number(e),r==r&&n==n?r>n||!(r<n)&&i:(r!=r||n==n)&&(n==n&&r!=r||t>e||!(t<e)&&(t==e?i:(r=t.toString())>(n=e.toString())||r==n&&i))}function p(t,e,i){return l.aeq(t,e)?0:l.lt(t,e,!1)?i?1:-1:l.gt(t,e,!1)?i?-1:1:0}function d(t,e,i,r,n,o){var s,a=o||0,l=e[a],c=!1;if("object"==typeof t&&l in t&&(s=t[l]),a+1>=e.length)c=i(s,r,n);else if(Array.isArray(s))for(var h=0,u=s.length;h<u&&!0!==(c=d(s[h],e,i,r,n,a+1));h+=1);else c=d(s,e,i,r,n,a+1);return c}function f(e){return"string"==typeof e||Array.isArray(e)?function(t){return-1!==e.indexOf(t)}:"object"==typeof e&&null!==e?function(i){return t.call(e,i)}:null}function y(e,i,r){for(var n in i)if(t.call(i,n))return g[n](e,i[n],r);return!1}var g={$eq:function(t,e){return t===e},$aeq:function(t,e){return t==e},$ne:function(t,e){return e!=e?t==t:t!==e},$dteq:function(t,e){return l.aeq(t,e)},$gt:function(t,e){return l.gt(t,e,!1)},$gte:function(t,e){return l.gt(t,e,!0)},$lt:function(t,e){return l.lt(t,e,!1)},$lte:function(t,e){return l.lt(t,e,!0)},$jgt:function(t,e){return t>e},$jgte:function(t,e){return t>=e},$jlt:function(t,e){return t<e},$jlte:function(t,e){return t<=e},$between:function(t,e){return null!=t&&l.gt(t,e[0],!0)&&l.lt(t,e[1],!0)},$jbetween:function(t,e){return null!=t&&t>=e[0]&&t<=e[1]},$in:function(t,e){return-1!==e.indexOf(t)},$inSet:function(t,e){return e.has(t)},$nin:function(t,e){return-1===e.indexOf(t)},$keyin:function(t,e){return t in e},$nkeyin:function(t,e){return!(t in e)},$definedin:function(t,e){return void 0!==e[t]},$undefinedin:function(t,e){return void 0===e[t]},$regex:function(t,e){return e.test(t)},$containsString:function(t,e){return"string"==typeof t&&-1!==t.indexOf(e)},$containsNone:function(t,e){return!g.$containsAny(t,e)},$containsAny:function(t,e){var i=f(t);return null!==i&&(Array.isArray(e)?e.some(i):i(e))},$contains:function(t,e){var i=f(t);return null!==i&&(Array.isArray(e)?e.every(i):i(e))},$elemMatch:function(t,e){return!!Array.isArray(t)&&t.some((function(t){return Object.keys(e).every((function(i){var r=e[i];return"object"==typeof r&&r||(r={$eq:r}),-1!==i.indexOf(".")?d(t,i.split("."),y,e[i],t):y(t[i],r,t)}))}))},$type:function(t,e,i){var r=typeof t;return"object"===r&&(Array.isArray(t)?r="array":t instanceof Date&&(r="date")),"object"!=typeof e?r===e:y(r,e,i)},$finite:function(t,e){return e===isFinite(t)},$size:function(t,e,i){return!!Array.isArray(t)&&("object"!=typeof e?t.length===e:y(t.length,e,i))},$len:function(t,e,i){return"string"==typeof t&&("object"!=typeof e?t.length===e:y(t.length,e,i))},$where:function(t,e){return!0===e(t)},$not:function(t,e,i){return!y(t,e,i)},$and:function(t,e,i){for(var r=0,n=e.length;r<n;r+=1)if(!y(t,e[r],i))return!1;return!0},$or:function(t,e,i){for(var r=0,n=e.length;r<n;r+=1)if(y(t,e[r],i))return!0;return!1},$exists:function(t,e){return e?void 0!==t:void 0===t}};["$eq","$aeq","$ne","$dteq","$gt","$gte","$lt","$lte","$jgt","$jgte","$jlt","$jlte","$type"].forEach((function(t){var e=g[t];g["$"+t]=function(t,i,r){if("string"==typeof i)return e(t,r[i]);if("function"==typeof i)return e(t,i(r));throw new Error("Invalid argument to $$ matcher")}}));var v={$eq:g.$eq,$aeq:!0,$dteq:!0,$gt:!0,$gte:!0,$lt:!0,$lte:!0,$in:!0,$between:!0};function m(t,e){if(null==t)return null;var i;switch(e||"parse-stringify"){case"parse-stringify":i=JSON.parse(JSON.stringify(t));break;case"jquery-extend-deep":i=jQuery.extend(!0,{},t);break;case"shallow":i=Object.create(t.constructor.prototype),Object.keys(t).map((function(e){i[e]=t[e]}));break;case"shallow-assign":i=Object.create(t.constructor.prototype),Object.assign(i,t);break;case"shallow-recurse-objects":i=m(t,"shallow"),Object.keys(t).forEach((function(e){"object"==typeof t[e]&&"Object"===t[e].constructor.name?i[e]=m(t[e],"shallow-recurse-objects"):Array.isArray(t[e])&&(i[e]=function(t,e){if("parse-stringify"==e)return m(t,e);for(var i=[],r=0,n=t.length;r<n;r++)i[r]=m(t[r],e);return i}(t[e],"shallow-recurse-objects"))}))}return i}function b(){try{return window&&void 0!==window.localStorage&&null!==window.localStorage}catch(t){return!1}}function w(){}function I(t,e){this.filename=t||"loki.db",this.collections=[],this.databaseVersion=1.5,this.engineVersion=1.5,this.autosave=!1,this.autosaveInterval=5e3,this.autosaveHandle=null,this.throttledSaves=!0,this.options={},this.persistenceMethod=null,this.persistenceAdapter=null,this.throttledSavePending=!1,this.throttledCallbacks=[],this.verbose=!(!e||!e.hasOwnProperty("verbose"))&&e.verbose,this.events={init:[],loaded:[],flushChanges:[],close:[],changes:[],warning:[]},e&&e.hasOwnProperty("env")?this.ENV=e.env:this.ENV=void 0!==r&&(r.android||r.NSObject)?"NATIVESCRIPT":"undefined"==typeof window||void 0!==r&&r.window&&void 0!==n?"NODEJS":"undefined"!=typeof document?-1===document.URL.indexOf("http://")&&-1===document.URL.indexOf("https://")?"CORDOVA":"BROWSER":"CORDOVA","undefined"===this.ENV&&(this.ENV="NODEJS"),this.configureOptions(e,!0),this.on("init",this.clearChanges)}function O(t){this.hashStore={},this.options=t||{},this.options.hasOwnProperty("asyncResponses")||(this.options.asyncResponses=!1),this.options.hasOwnProperty("asyncTimeout")||(this.options.asyncTimeout=50)}function S(t,e){if(this.mode="reference",this.adapter=null,this.options=e||{},this.dbref=null,this.dbname="",this.pageIterator={},!t)throw new Error("LokiPartitioningAdapter requires a (non-reference mode) adapter on construction");if("reference"===t.mode)throw new Error("LokiPartitioningAdapter cannot be instantiated with a reference mode adapter");this.adapter=t,this.options.hasOwnProperty("paging")||(this.options.paging=!1),this.options.hasOwnProperty("pageSize")||(this.options.pageSize=26214400),this.options.hasOwnProperty("delimiter")||(this.options.delimiter="$<\n")}function x(){try{this.fs=i(!function(){var t=new Error("Cannot find module 'fs'");throw t.code="MODULE_NOT_FOUND",t}())}catch(t){this.fs=null}}function A(){}function k(t,e){return e=e||{},this.collection=t,this.filteredrows=[],this.filterInitialized=!1,this}function D(t,e,i){this.collection=t,this.name=e,this.rebuildPending=!1,this.options=i||{},this.options.hasOwnProperty("persistent")||(this.options.persistent=!1),this.options.hasOwnProperty("sortPriority")||(this.options.sortPriority="passive"),this.options.hasOwnProperty("minRebuildInterval")||(this.options.minRebuildInterval=1),this.resultset=new k(t),this.resultdata=[],this.resultsdirty=!1,this.cachedresultset=null,this.filterPipeline=[],this.collection.disableFreeze||Object.freeze(this.filterPipeline),this.sortFunction=null,this.sortCriteria=null,this.sortCriteriaSimple=null,this.sortDirty=!1,this.events={rebuild:[],filter:[],sort:[]}}function P(e,i){this.name=e,this.data=[],this.idIndex=null,this.binaryIndices={},this.constraints={unique:{},exact:{}},this.uniqueNames=[],this.transforms={},this.objType=e,this.dirty=!0,this.cachedIndex=null,this.cachedBinaryIndex=null,this.cachedData=null;var r=this;(i=i||{}).hasOwnProperty("unique")&&(Array.isArray(i.unique)||(i.unique=[i.unique]),i.unique.forEach((function(t){r.uniqueNames.push(t)}))),i.hasOwnProperty("exact")&&i.exact.forEach((function(t){r.constraints.exact[t]=new T(t)})),this.adaptiveBinaryIndices=!i.hasOwnProperty("adaptiveBinaryIndices")||i.adaptiveBinaryIndices,this.transactional=!!i.hasOwnProperty("transactional")&&i.transactional,this.cloneObjects=!!i.hasOwnProperty("clone")&&i.clone,this.cloneMethod=i.hasOwnProperty("cloneMethod")?i.cloneMethod:"parse-stringify",this.asyncListeners=!!i.hasOwnProperty("asyncListeners")&&i.asyncListeners,this.disableMeta=!!i.hasOwnProperty("disableMeta")&&i.disableMeta,this.disableChangesApi=!i.hasOwnProperty("disableChangesApi")||i.disableChangesApi,this.disableDeltaChangesApi=!i.hasOwnProperty("disableDeltaChangesApi")||i.disableDeltaChangesApi,this.disableChangesApi&&(this.disableDeltaChangesApi=!0),this.autoupdate=!!i.hasOwnProperty("autoupdate")&&i.autoupdate,this.serializableIndices=!i.hasOwnProperty("serializableIndices")||i.serializableIndices,this.disableFreeze=!i.hasOwnProperty("disableFreeze")||i.disableFreeze,this.ttl={age:null,ttlInterval:null,daemon:null},this.setTTL(i.ttl||-1,i.ttlInterval),this.maxId=0,this.DynamicViews=[],this.events={insert:[],update:[],"pre-insert":[],"pre-update":[],close:[],flushbuffer:[],error:[],delete:[],warning:[]},this.changes=[],this.dirtyIds=[];var n=[];if(i&&i.indices)if("[object Array]"===Object.prototype.toString.call(i.indices))n=i.indices;else{if("string"!=typeof i.indices)throw new TypeError("Indices needs to be a string or an array of strings");n=[i.indices]}for(var o=0;o<n.length;o++)this.ensureIndex(n[o]);function s(t,e){var i=null!==e&&"object"==typeof e?Object.keys(e):null;if(i&&i.length&&["string","boolean","number"].indexOf(typeof e)<0){for(var n={},o=0;o<i.length;o++){var a=i[o];if(e.hasOwnProperty(a))if(!t.hasOwnProperty(a)||r.uniqueNames.indexOf(a)>=0||"$loki"==a||"meta"==a)n[a]=e[a];else{var l=s(t[a],e[a]);void 0!==l&&l!={}&&(n[a]=l)}}return 0===Object.keys(n).length?void 0:n}return t===e?void 0:e}function a(){r.changes=[]}this.observerCallback=function(e){var i="function"==typeof Set?new Set:[];i.add||(i.add=function(t){return-1===this.indexOf(t)&&this.push(t),this}),e.forEach((function(t){i.add(t.object)})),i.forEach((function(e){if(!t.call(e,"$loki"))return r.removeAutoUpdateObserver(e);try{r.update(e)}catch(t){}}))},this.getChangeDelta=function(t,e){return e?s(e,t):JSON.parse(JSON.stringify(t))},this.getObjectDelta=s,this.getChanges=function(){return r.changes},this.flushChanges=a,this.setChangesApi=function(t){r.disableChangesApi=!t,t||(r.disableDeltaChangesApi=!1)},this.on("delete",(function(t){r.disableChangesApi||r.createChange(r.name,"R",t)})),this.on("warning",(function(t){r.lokiConsoleWrapper.warn(t)})),a()}function C(t){return-1!==t.indexOf(".")}function E(t){return parseFloat(t,10)}function j(t,e){return t+e}function $(t,e){return t-e}function z(t){return t.reduce(j,0)/t.length}function N(t,e,i){if(!1===i)return t[e];for(var r=e.split("."),n=t;r.length>0;)n=n[r.shift()];return n}function q(t,e,i){for(var r,n,o=0,s=t.length;o<s;){if(n=o+s>>1,0===(r=i.apply(null,[e,t[n]])))return{found:!0,index:n};r<0?s=n:o=n+1}return{found:!1,index:s}}function M(t){return function(e,i){return q(e,i,t)}}function R(){}function F(t){this.field=t,this.keyMap=Object.create(null),this.lokiMap=Object.create(null)}function T(t){this.index=Object.create(null),this.field=t}return w.prototype.events={},w.prototype.asyncListeners=!1,w.prototype.on=function(t,e){var i,r=this;return Array.isArray(t)?(t.forEach((function(t){r.on(t,e)})),e):((i=this.events[t])||(i=this.events[t]=[]),i.push(e),e)},w.prototype.emit=function(t){var e,i=this;if(!t||!this.events[t])throw new Error("No event "+t+" defined");this.events[t].length&&(e=Array.prototype.slice.call(arguments,1),this.events[t].forEach((function(t){i.asyncListeners?setTimeout((function(){t.apply(i,e)}),1):t.apply(i,e)})))},w.prototype.addListener=w.prototype.on,w.prototype.removeListener=function(t,e){var i=this;if(Array.isArray(t))t.forEach((function(t){i.removeListener(t,e)}));else if(this.events[t]){var r=this.events[t];r.splice(r.indexOf(e),1)}},I.prototype=new w,I.prototype.constructor=I,I.prototype.getIndexedAdapter=function(){return i(21)},I.prototype.configureOptions=function(t,e){var i={fs:x,localStorage:A,memory:O};if(this.options={},this.persistenceMethod=null,this.persistenceAdapter=null,void 0!==t){if(this.options=t,this.options.hasOwnProperty("persistenceMethod")&&"function"==typeof i[t.persistenceMethod]&&(this.persistenceMethod=t.persistenceMethod,this.persistenceAdapter=new i[t.persistenceMethod]),this.options.hasOwnProperty("adapter")&&(this.persistenceMethod="adapter",this.persistenceAdapter=t.adapter,this.options.adapter=null,this.isIncremental="incremental"===this.persistenceAdapter.mode),t.autoload&&e){var r=this;setTimeout((function(){r.loadDatabase(t,t.autoloadCallback)}),1)}this.options.hasOwnProperty("autosaveInterval")&&(this.autosaveDisable(),this.autosaveInterval=parseInt(this.options.autosaveInterval,10)),this.options.hasOwnProperty("autosave")&&this.options.autosave&&(this.autosaveDisable(),this.autosave=!0,this.options.hasOwnProperty("autosaveCallback")?this.autosaveEnable(t,t.autosaveCallback):this.autosaveEnable()),this.options.hasOwnProperty("throttledSaves")&&(this.throttledSaves=this.options.throttledSaves)}this.options.hasOwnProperty("serializationMethod")||(this.options.serializationMethod="normal"),this.options.hasOwnProperty("destructureDelimiter")||(this.options.destructureDelimiter="$<\n"),null===this.persistenceAdapter&&(this.persistenceMethod={NODEJS:"fs",BROWSER:"localStorage",CORDOVA:"localStorage",MEMORY:"memory"}[this.ENV],this.persistenceMethod&&(this.persistenceAdapter=new i[this.persistenceMethod]))},I.prototype.copy=function(t){var e,i,r=new I(this.filename,{env:"NA"});if(t=t||{},r.loadJSONObject(this,{retainDirtyFlags:!0}),t.hasOwnProperty("removeNonSerializable")&&!0===t.removeNonSerializable)for(r.autosaveHandle=null,r.persistenceAdapter=null,e=r.collections.length,i=0;i<e;i++)r.collections[i].constraints=null,r.collections[i].ttl=null;return r},I.prototype.addCollection=function(t,e){var i,r=this.collections.length;if(e&&!0===e.disableMeta){if(!1===e.disableChangesApi)throw new Error("disableMeta option cannot be passed as true when disableChangesApi is passed as false");if(!1===e.disableDeltaChangesApi)throw new Error("disableMeta option cannot be passed as true when disableDeltaChangesApi is passed as false");if("number"==typeof e.ttl&&e.ttl>0)throw new Error("disableMeta option cannot be passed as true when ttl is enabled")}for(i=0;i<r;i+=1)if(this.collections[i].name===t)return this.collections[i];var n=new P(t,e);return n.isIncremental=this.isIncremental,this.collections.push(n),this.verbose&&(n.lokiConsoleWrapper=console),n},I.prototype.loadCollection=function(t){if(!t.name)throw new Error("Collection must have a name property to be loaded");this.collections.push(t)},I.prototype.getCollection=function(t){var e,i=this.collections.length;for(e=0;e<i;e+=1)if(this.collections[e].name===t)return this.collections[e];return this.emit("warning","collection "+t+" not found"),null},I.prototype.renameCollection=function(t,e){var i=this.getCollection(t);return i&&(i.name=e),i},I.prototype.listCollections=function(){for(var t=this.collections.length,e=[];t--;)e.push({name:this.collections[t].name,type:this.collections[t].objType,count:this.collections[t].data.length});return e},I.prototype.removeCollection=function(t){var e,i=this.collections.length;for(e=0;e<i;e+=1)if(this.collections[e].name===t){var r=new P(t,{}),n=this.collections[e];for(var o in n)n.hasOwnProperty(o)&&r.hasOwnProperty(o)&&(n[o]=r[o]);return void this.collections.splice(e,1)}},I.prototype.getName=function(){return this.name},I.prototype.serializeReplacer=function(t,e){switch(t){case"autosaveHandle":case"persistenceAdapter":case"constraints":case"ttl":return null;case"throttledSavePending":case"throttledCallbacks":return;case"lokiConsoleWrapper":return null;default:return e}},I.prototype.serialize=function(t){switch((t=t||{}).hasOwnProperty("serializationMethod")||(t.serializationMethod=this.options.serializationMethod),t.serializationMethod){case"normal":return JSON.stringify(this,this.serializeReplacer);case"pretty":return JSON.stringify(this,this.serializeReplacer,2);case"destructured":return this.serializeDestructured();default:return JSON.stringify(this,this.serializeReplacer)}},I.prototype.toJson=I.prototype.serialize,I.prototype.serializeDestructured=function(t){var e,i,r,n,o,s=[];if((t=t||{}).hasOwnProperty("partitioned")||(t.partitioned=!1),t.hasOwnProperty("delimited")||(t.delimited=!0),t.hasOwnProperty("delimiter")||(t.delimiter=this.options.destructureDelimiter),!0===t.partitioned&&t.hasOwnProperty("partition")&&t.partition>=0)return this.serializeCollection({delimited:t.delimited,delimiter:t.delimiter,collectionIndex:t.partition});for((o=new I(this.filename)).loadJSONObject(this),e=0;e<o.collections.length;e++)o.collections[e].data=[];if(!0===t.partitioned&&-1===t.partition)return o.serialize({serializationMethod:"normal"});for(s.push(o.serialize({serializationMethod:"normal"})),o=null,e=0;e<this.collections.length;e++)if(r=this.serializeCollection({delimited:t.delimited,delimiter:t.delimiter,collectionIndex:e}),!1===t.partitioned&&!1===t.delimited){if(!Array.isArray(r))throw new Error("a nondelimited, non partitioned collection serialization did not return an expected array");for(n=r.length,i=0;i<n;i++)s.push(r[i]),r[i]=null;s.push("")}else s.push(r);return t.partitioned?(t.delimited,s):t.delimited?(s.push(""),s.join(t.delimiter)):(s.push(""),s)},I.prototype.serializeCollection=function(t){var e,i,r=[];if((t=t||{}).hasOwnProperty("delimited")||(t.delimited=!0),!t.hasOwnProperty("collectionIndex"))throw new Error("serializeCollection called without 'collectionIndex' option");for(e=this.collections[t.collectionIndex].data.length,r=[],i=0;i<e;i++)r.push(JSON.stringify(this.collections[t.collectionIndex].data[i]));return t.delimited?(r.push(""),r.join(t.delimiter)):r},I.prototype.deserializeDestructured=function(t,e){var i,r,n,o=[],s=0,a=1,l=!1;if((e=e||{}).hasOwnProperty("partitioned")||(e.partitioned=!1),e.hasOwnProperty("delimited")||(e.delimited=!0),e.hasOwnProperty("delimiter")||(e.delimiter=this.options.destructureDelimiter),e.partitioned){if(e.hasOwnProperty("partition"))return-1===e.partition?i=JSON.parse(t[0]):this.deserializeCollection(t[e.partition+1],e);for(r=(i=JSON.parse(t[0])).collections.length,s=0;s<r;s++)i.collections[s].data=this.deserializeCollection(t[s+1],e);return i}if(e.delimited){if(o=t.split(e.delimiter),t=null,0===o.length)return null}else o=t;for(r=(i=JSON.parse(o[0])).collections.length,o[0]=null;!l;)o[a],""===o[a]?++s>r&&(l=!0):(n=JSON.parse(o[a]),i.collections[s].data.push(n)),o[a++]=null;return i},I.prototype.deserializeCollection=function(t,e){var i,r,n=[];for((e=e||{}).hasOwnProperty("partitioned")||(e.partitioned=!1),e.hasOwnProperty("delimited")||(e.delimited=!0),e.hasOwnProperty("delimiter")||(e.delimiter=this.options.destructureDelimiter),e.delimited?(n=t.split(e.delimiter)).pop():n=t,r=n.length,i=0;i<r;i++)n[i]=JSON.parse(n[i]);return n},I.prototype.loadJSON=function(t,e){var i;if(0===t.length)i={};else switch(this.options.serializationMethod){case"normal":case"pretty":i=JSON.parse(t);break;case"destructured":i=this.deserializeDestructured(t);break;default:i=JSON.parse(t)}this.loadJSONObject(i,e)},I.prototype.loadJSONObject=function(t,i){var r,n,o,s,l,c,h=0,u=t.collections?t.collections.length:0;function p(t){var e,r=i[t.name];return r.proto?(e=r.inflate||a.copyProperties,function(t){var i=new r.proto;return e(t,i),i}):r.inflate}for(this.name=t.name,t.hasOwnProperty("throttledSaves")&&i&&!i.hasOwnProperty("throttledSaves")&&(this.throttledSaves=t.throttledSaves),this.collections=[];h<u;h+=1){if(r=t.collections[h],(n=this.addCollection(r.name,{disableChangesApi:r.disableChangesApi,disableDeltaChangesApi:r.disableDeltaChangesApi,disableMeta:r.disableMeta,disableFreeze:!r.hasOwnProperty("disableFreeze")||r.disableFreeze})).adaptiveBinaryIndices=!!r.hasOwnProperty("adaptiveBinaryIndices")&&!0===r.adaptiveBinaryIndices,n.transactional=r.transactional,n.asyncListeners=r.asyncListeners,n.cloneObjects=r.cloneObjects,n.cloneMethod=r.cloneMethod||"parse-stringify",n.autoupdate=r.autoupdate,n.changes=r.changes,n.dirtyIds=r.dirtyIds||[],i&&!0===i.retainDirtyFlags?n.dirty=r.dirty:n.dirty=!1,o=r.data.length,s=0,i&&i.hasOwnProperty(r.name))for(l=p(r);s<o;s++)c=l(r.data[s]),n.data[s]=c,n.addAutoUpdateObserver(c),n.disableFreeze||e(n.data[s]);else for(;s<o;s++)n.data[s]=r.data[s],n.addAutoUpdateObserver(n.data[s]),n.disableFreeze||e(n.data[s]);if(n.maxId=void 0===r.maxId?0:r.maxId,void 0!==r.binaryIndices&&(n.binaryIndices=r.binaryIndices),void 0!==r.transforms&&(n.transforms=r.transforms),n.uniqueNames=[],r.hasOwnProperty("uniqueNames")&&(n.uniqueNames=r.uniqueNames),void 0!==r.DynamicViews){for(var d=0;d<r.DynamicViews.length;d++){var f=r.DynamicViews[d],y=n.addDynamicView(f.name,f.options);y.resultdata=f.resultdata,y.resultsdirty=f.resultsdirty,y.filterPipeline=f.filterPipeline,y.sortCriteriaSimple=f.sortCriteriaSimple,y.sortCriteria=f.sortCriteria,y.sortFunction=null,y.sortDirty=f.sortDirty,n.disableFreeze||(e(y.filterPipeline),y.sortCriteriaSimple?e(y.sortCriteriaSimple):y.sortCriteria&&e(y.sortCriteria)),y.resultset.filteredrows=f.resultset.filteredrows,y.resultset.filterInitialized=f.resultset.filterInitialized,y.rematerialize({removeWhereFilters:!0})}t.databaseVersion<1.5&&(n.ensureAllIndexes(!0),n.dirty=!0)}}},I.prototype.close=function(t){this.autosave&&(this.autosaveDisable(),this.autosaveDirty()&&(this.saveDatabase(t),t=void 0)),t&&this.on("close",t),this.emit("close")},I.prototype.generateChangesNotification=function(t){function e(t){return t.name}var i=[],r=t||this.collections.map(e);return this.collections.forEach((function(t){-1!==r.indexOf(e(t))&&(i=i.concat(t.getChanges()))})),i},I.prototype.serializeChanges=function(t){return JSON.stringify(this.generateChangesNotification(t))},I.prototype.clearChanges=function(){this.collections.forEach((function(t){t.flushChanges&&t.flushChanges()}))},O.prototype.loadDatabase=function(t,e){var i=this;this.options.asyncResponses?setTimeout((function(){i.hashStore.hasOwnProperty(t)?e(i.hashStore[t].value):e(null)}),this.options.asyncTimeout):this.hashStore.hasOwnProperty(t)?e(this.hashStore[t].value):e(null)},O.prototype.saveDatabase=function(t,e,i){var r,n=this;this.options.asyncResponses?setTimeout((function(){r=n.hashStore.hasOwnProperty(t)?n.hashStore[t].savecount:0,n.hashStore[t]={savecount:r+1,lastsave:new Date,value:e},i()}),this.options.asyncTimeout):(r=this.hashStore.hasOwnProperty(t)?this.hashStore[t].savecount:0,this.hashStore[t]={savecount:r+1,lastsave:new Date,value:e},i())},O.prototype.deleteDatabase=function(t,e){this.hashStore.hasOwnProperty(t)&&delete this.hashStore[t],"function"==typeof e&&e()},S.prototype.loadDatabase=function(t,e){var i=this;this.dbname=t,this.dbref=new I(t),this.adapter.loadDatabase(t,(function(t){if(t){"string"!=typeof t&&e(new Error("LokiPartitioningAdapter received an unexpected response from inner adapter loadDatabase()"));var r=JSON.parse(t);i.dbref.loadJSONObject(r),r=null,i.dbref.collections.length,0!==i.dbref.collections.length?(i.pageIterator={collection:0,pageIndex:0},i.loadNextPartition(0,(function(){e(i.dbref)}))):e(i.dbref)}else e(t)}))},S.prototype.loadNextPartition=function(t,e){var i=this.dbname+"."+t,r=this;if(!0===this.options.paging)return this.pageIterator.pageIndex=0,void this.loadNextPage(e);this.adapter.loadDatabase(i,(function(i){var n=r.dbref.deserializeCollection(i,{delimited:!0,collectionIndex:t});r.dbref.collections[t].data=n,++t<r.dbref.collections.length?r.loadNextPartition(t,e):e()}))},S.prototype.loadNextPage=function(t){var e=this.dbname+"."+this.pageIterator.collection+"."+this.pageIterator.pageIndex,i=this;this.adapter.loadDatabase(e,(function(e){var r=e.split(i.options.delimiter);e="";var n,o=r.length,s=""===r[o-1];for(s&&(r.pop(),""===r[(o=r.length)-1]&&1===o&&(r.pop(),o=r.length)),n=0;n<o;n++)i.dbref.collections[i.pageIterator.collection].data.push(JSON.parse(r[n])),r[n]=null;r=[],s?++i.pageIterator.collection<i.dbref.collections.length?i.loadNextPartition(i.pageIterator.collection,t):t():(i.pageIterator.pageIndex++,i.loadNextPage(t))}))},S.prototype.exportDatabase=function(t,e,i){var r,n=e.collections.length;for(this.dbref=e,this.dbname=t,this.dirtyPartitions=[-1],r=0;r<n;r++)e.collections[r].dirty&&this.dirtyPartitions.push(r);this.saveNextPartition((function(t){i(t)}))},S.prototype.saveNextPartition=function(t){var e=this,i=this.dirtyPartitions.shift(),r=this.dbname+(-1===i?"":"."+i);if(this.options.paging&&-1!==i)return this.pageIterator={collection:i,docIndex:0,pageIndex:0},void this.saveNextPage((function(i){0===e.dirtyPartitions.length?t(i):e.saveNextPartition(t)}));var n=this.dbref.serializeDestructured({partitioned:!0,delimited:!0,partition:i});this.adapter.saveDatabase(r,n,(function(i){i?t(i):0===e.dirtyPartitions.length?t(null):e.saveNextPartition(t)}))},S.prototype.saveNextPage=function(t){var e=this,i=this.dbref.collections[this.pageIterator.collection],r=this.dbname+"."+this.pageIterator.collection+"."+this.pageIterator.pageIndex,n=0,o=i.data.length,s=this.options.delimiter.length,a="",l="",c=!1,h=!1,u=function(i){l="",i&&t(i),c?t(null):(e.pageIterator.pageIndex++,e.saveNextPage(t))};for(0===i.data.length&&(c=!0);;)if(c||(a=JSON.stringify(i.data[this.pageIterator.docIndex]),l+=a,n+=a.length,++this.pageIterator.docIndex>=o&&(c=!0)),n>=this.options.pageSize&&(h=!0),h&&!c||(l+=this.options.delimiter,n+=s),c||h)return void this.adapter.saveDatabase(r,l,u)},x.prototype.loadDatabase=function(t,e){var i=this;this.fs.stat(t,(function(r,n){!r&&n.isFile()?i.fs.readFile(t,{encoding:"utf8"},(function(t,i){e(t?new Error(t):i)})):e(null)}))},x.prototype.saveDatabase=function(t,e,i){var r=this,n=t+"~";this.fs.writeFile(n,e,(function(e){e?i(new Error(e)):r.fs.rename(n,t,i)}))},x.prototype.deleteDatabase=function(t,e){this.fs.unlink(t,(function(t){t?e(new Error(t)):e()}))},A.prototype.loadDatabase=function(t,e){b()?e(localStorage.getItem(t)):e(new Error("localStorage is not available"))},A.prototype.saveDatabase=function(t,e,i){b()?(localStorage.setItem(t,e),i(null)):i(new Error("localStorage is not available"))},A.prototype.deleteDatabase=function(t,e){b()?(localStorage.removeItem(t),e(null)):e(new Error("localStorage is not available"))},I.prototype.throttledSaveDrain=function(t,e){var i=this,r=(new Date).getTime();if(this.throttledSaves||t(!0),(e=e||{}).hasOwnProperty("recursiveWait")||(e.recursiveWait=!0),e.hasOwnProperty("recursiveWaitLimit")||(e.recursiveWaitLimit=!1),e.hasOwnProperty("recursiveWaitLimitDuration")||(e.recursiveWaitLimitDuration=2e3),e.hasOwnProperty("started")||(e.started=(new Date).getTime()),this.throttledSaves&&this.throttledSavePending){if(!e.recursiveWait)return void this.throttledCallbacks.push(t);this.throttledCallbacks.push((function(){return i.throttledSavePending?e.recursiveWaitLimit&&r-e.started>e.recursiveWaitLimitDuration?void t(!1):void i.throttledSaveDrain(t,e):void t(!0)}))}else t(!0)},I.prototype.loadDatabaseInternal=function(t,e){var i=e||function(t,e){if(t)throw t},r=this;null!==this.persistenceAdapter?this.persistenceAdapter.loadDatabase(this.filename,(function(e){if("string"==typeof e){var n=!1;try{r.loadJSON(e,t||{}),n=!0}catch(t){i(t)}n&&(i(null),r.emit("loaded","database "+r.filename+" loaded"))}else{if(!e)return i(null),void r.emit("loaded","empty database "+r.filename+" loaded");if(e instanceof Error)return void i(e);if("object"==typeof e)return r.loadJSONObject(e,t||{}),i(null),void r.emit("loaded","database "+r.filename+" loaded");i("unexpected adapter response : "+e)}})):i(new Error("persistenceAdapter not configured"))},I.prototype.loadDatabase=function(t,e){var i=this;this.throttledSaves?this.throttledSaveDrain((function(r){if(r)return i.throttledSavePending=!0,void i.loadDatabaseInternal(t,(function(t){0===i.throttledCallbacks.length?i.throttledSavePending=!1:i.saveDatabase(),"function"==typeof e&&e(t)}));"function"==typeof e&&e(new Error("Unable to pause save throttling long enough to read database"))}),t):this.loadDatabaseInternal(t,e)},I.prototype.saveDatabaseInternal=function(t){var e,i=t||function(t){if(t)throw t},r=this;this.persistenceAdapter?"incremental"===this.persistenceAdapter.mode?(this.ignoreAutosave=!0,this.persistenceAdapter.saveDatabase(this.filename,(function(){if(r.ignoreAutosave=!1,!e){var t=r.copy({removeNonSerializable:!0});return e=r.collections.map((function(t){return[t.dirty,t.dirtyIds]})),r.collections.forEach((function(t){t.dirty=!1,t.dirtyIds=[]})),t}i(new Error("adapter error - getLokiCopy called more than once"))}),(function(t){r.ignoreAutosave=!1,t&&e&&r.collections.forEach((function(t,i){var r=e[i];t.dirty=t.dirty||r[0],t.dirtyIds=t.dirtyIds.concat(r[1])})),i(t)}))):"reference"===this.persistenceAdapter.mode&&"function"==typeof this.persistenceAdapter.exportDatabase?this.persistenceAdapter.exportDatabase(this.filename,this.copy({removeNonSerializable:!0}),(function(t){r.autosaveClearFlags(),i(t)})):(this.autosaveClearFlags(),this.persistenceAdapter.saveDatabase(this.filename,this.serialize(),(function(t){i(t)}))):i(new Error("persistenceAdapter not configured"))},I.prototype.saveDatabase=function(t){if(this.throttledSaves)if(this.throttledSavePending)this.throttledCallbacks.push(t);else{var e=this.throttledCallbacks;this.throttledCallbacks=[],e.unshift(t),this.throttledSavePending=!0;var i=this;this.saveDatabaseInternal((function(t){i.throttledSavePending=!1,e.forEach((function(e){"function"==typeof e&&setTimeout((function(){e(t)}),1)})),i.throttledCallbacks.length>0&&i.saveDatabase()}))}else this.saveDatabaseInternal(t)},I.prototype.save=I.prototype.saveDatabase,I.prototype.deleteDatabase=function(t,e){var i=e||function(t,e){if(t)throw t};"function"!=typeof t||e||(i=t),null!==this.persistenceAdapter?this.persistenceAdapter.deleteDatabase(this.filename,(function(t){i(t)})):i(new Error("persistenceAdapter not configured"))},I.prototype.autosaveDirty=function(){for(var t=0;t<this.collections.length;t++)if(this.collections[t].dirty)return!0;return!1},I.prototype.autosaveClearFlags=function(){for(var t=0;t<this.collections.length;t++)this.collections[t].dirty=!1},I.prototype.autosaveEnable=function(t,e){this.autosave=!0;var i=5e3,r=this;void 0!==this.autosaveInterval&&null!==this.autosaveInterval&&(i=this.autosaveInterval),this.autosaveHandle=setInterval((function(){r.autosaveDirty()&&!r.ignoreAutosave&&r.saveDatabase(e)}),i)},I.prototype.autosaveDisable=function(){void 0!==this.autosaveHandle&&null!==this.autosaveHandle&&(clearInterval(this.autosaveHandle),this.autosaveHandle=null)},k.prototype.reset=function(){return this.filteredrows.length>0&&(this.filteredrows=[]),this.filterInitialized=!1,this},k.prototype.toJSON=function(){var t=this.copy();return t.collection=null,t},k.prototype.limit=function(t){this.filterInitialized||0!==this.filteredrows.length||(this.filteredrows=this.collection.prepareFullDocIndex());var e=new k(this.collection);return e.filteredrows=this.filteredrows.slice(0,t),e.filterInitialized=!0,e},k.prototype.offset=function(t){this.filterInitialized||0!==this.filteredrows.length||(this.filteredrows=this.collection.prepareFullDocIndex());var e=new k(this.collection);return e.filteredrows=this.filteredrows.slice(t),e.filterInitialized=!0,e},k.prototype.copy=function(){var t=new k(this.collection);return this.filteredrows.length>0&&(t.filteredrows=this.filteredrows.slice()),t.filterInitialized=this.filterInitialized,t},k.prototype.branch=k.prototype.copy,k.prototype.transform=function(t,e){var i,r,n=this;if("string"==typeof t&&this.collection.transforms.hasOwnProperty(t)&&(t=this.collection.transforms[t]),"object"!=typeof t||!Array.isArray(t))throw new Error("Invalid transform");for(void 0!==e&&(t=a.resolveTransformParams(t,e)),i=0;i<t.length;i++)switch((r=t[i]).type){case"find":n.find(r.value);break;case"where":n.where(r.value);break;case"simplesort":n.simplesort(r.property,r.desc||r.options);break;case"compoundsort":n.compoundsort(r.value);break;case"sort":n.sort(r.value);break;case"limit":n=n.limit(r.value);break;case"offset":n=n.offset(r.value);break;case"map":n=n.map(r.value,r.dataOptions);break;case"eqJoin":n=n.eqJoin(r.joinData,r.leftJoinKey,r.rightJoinKey,r.mapFun,r.dataOptions);break;case"mapReduce":n=n.mapReduce(r.mapFunction,r.reduceFunction);break;case"update":n.update(r.value);break;case"remove":n.remove()}return n},k.prototype.sort=function(t){this.filterInitialized||0!==this.filteredrows.length||(this.filteredrows=this.collection.prepareFullDocIndex());var e,i,r=(e=t,i=this.collection.data,function(t,r){return e(i[t],i[r])});return this.filteredrows.sort(r),this},k.prototype.simplesort=function(t,e){var i,r=10,n=this.collection.data.length,o=this.filteredrows.length,s=this.collection.binaryIndices.hasOwnProperty(t);if(void 0!==e&&!1!==e||(e={desc:!1}),!0===e&&(e={desc:!0}),0===o){if(this.filterInitialized)return this;if(this.collection.binaryIndices.hasOwnProperty(t))return this.collection.ensureIndex(t),this.filteredrows=this.collection.binaryIndices[t].values.slice(0),e.desc&&this.filteredrows.reverse(),this;this.filteredrows=this.collection.prepareFullDocIndex()}else if(!e.disableIndexIntersect&&s&&(i=n/o,e.useJavascriptSorting&&(r=6),i<=r||e.forceIndexIntersect)){var l,c=this.filteredrows,h={};for(l=0;l<o;l++)h[c[l]]=!0;var u=this.collection.binaryIndices[t].values;return this.filteredrows=u.filter((function(t){return h[t]})),e.desc&&this.filteredrows.reverse(),this}if(e.useJavascriptSorting)return this.sort((function(e,i){return e[t]===i[t]?0:e[t]>i[t]?1:e[t]<i[t]?-1:void 0}));var d,f,y,g,v,m,b=(d=t,f=e.desc,y=this.collection.data,function(t,e){return~d.indexOf(".")?(m=d.split("."),g=a.getIn(y[t],m,!0),v=a.getIn(y[e],m,!0)):(g=y[t][d],v=y[e][d]),p(g,v,f)});return this.filteredrows.sort(b),this},k.prototype.compoundsort=function(t){if(0===t.length)throw new Error("Invalid call to compoundsort, need at least one property");var e;if(1===t.length)return e=t[0],Array.isArray(e)?this.simplesort(e[0],e[1]):this.simplesort(e,!1);for(var i=0,r=t.length;i<r;i+=1)e=t[i],Array.isArray(e)||(t[i]=[e,!1]);this.filterInitialized||0!==this.filteredrows.length||(this.filteredrows=this.collection.prepareFullDocIndex());var n,o,s=(n=t,o=this.collection.data,function(t,e){return function(t,e,i){for(var r,n,o,s,l,c=0,h=0,u=t.length;h<u;h++)if(~(n=(r=t[h])[0]).indexOf(".")?(l=n.split("."),o=a.getIn(e,l,!0),s=a.getIn(i,l,!0)):(o=e[n],s=i[n]),0!==(c=p(o,s,r[1])))return c;return 0}(n,o[t],o[e])});return this.filteredrows.sort(s),this},k.prototype.findOr=function(t){for(var e=null,i=0,r=0,n=[],o=[],s=0,a=(this.count(),0),l=t.length;a<l;a++)for(r=(e=this.branch().find(t[a]).filteredrows).length,i=0;i<r;i++)void 0===o[s=e[i]]&&(o[s]=!0,n.push(s));return this.filteredrows=n,this.filterInitialized=!0,this},k.prototype.$or=k.prototype.findOr,k.prototype.findAnd=function(t){for(var e=0,i=t.length;e<i;e++){if(0===this.count())return this;this.find(t[e])}return this},k.prototype.$and=k.prototype.findAnd,k.prototype.find=function(e,i){if(0===this.collection.data.length)return this.filteredrows=[],this.filterInitialized=!0,this;var r,n,o,s,l,c,h,u=e||"getAll",p=!1,f=[],y=[],m=null;if(i=i||!1,"object"==typeof u){for(r in u)(s={})[r]=u[r],y.push(s),t.call(u,r)&&(n=r,o=u[r]);if(y.length>1)return this.find({$and:y},i)}if(!n||"getAll"===u)return i&&(this.filterInitialized?this.filteredrows=this.filteredrows.slice(0,1):(this.filteredrows=this.collection.data.length>0?[0]:[],this.filterInitialized=!0)),this;if("$and"===n||"$or"===n)return this[n](o),i&&this.filteredrows.length>1&&(this.filteredrows=this.filteredrows.slice(0,1)),this;if(null===o||"object"!=typeof o||o instanceof Date)l="$eq",c=o;else{if("object"!=typeof o)throw new Error("Do not know what you want to do.");for(h in o)if(t.call(o,h)){l=h,c=o[h];break}}"$regex"!==l&&"object"!=typeof c||(c=function t(e,i){if("$regex"===e)Array.isArray(i)?i=new RegExp(i[0],i[1]):i instanceof RegExp||(i=new RegExp(i));else if("object"==typeof i)for(var r in i)"$regex"!==r&&"object"!=typeof i[r]||(i[r]=t(r,i[r]));return i}(l,c));var b=-1!==n.indexOf(".");!this.filterInitialized&&this.collection.binaryIndices[n]&&v[l]&&(!0!==this.collection.adaptiveBinaryIndices&&this.collection.ensureIndex(n),p=!0,m=this.collection.binaryIndices[n]),!p&&"$in"===l&&Array.isArray(c)&&"undefined"!=typeof Set&&(c=new Set(c),l="$inSet");var w,I,O=g[l],S=this.collection.data,x=0,A=0,k=0;if(this.filterInitialized){if(A=(w=this.filteredrows).length,b){for(n=n.split("."),x=0;x<A;x++)if(d(I=S[k=w[x]],n,O,c,I)&&(f.push(k),i))return this.filteredrows=f,this}else for(x=0;x<A;x++)if(O((I=S[k=w[x]])[n],c,I)&&(f.push(k),i))return this.filteredrows=f,this}else if(p){var D=this.collection.calculateRange(l,n,c);if("$in"!==l){for(x=D[0];x<=D[1];x++)if(!0!==v[l]){if(v[l](a.getIn(S[m.values[x]],n,b),c)&&(f.push(m.values[x]),i))return this.filteredrows=f,this.filterInitialized=!0,this}else if(f.push(m.values[x]),i)return this.filteredrows=f,this.filterInitialized=!0,this}else for(x=0,A=D.length;x<A;x++)if(f.push(m.values[D[x]]),i)return this.filteredrows=f,this.filterInitialized=!0,this}else if(A=S.length,b){for(n=n.split("."),x=0;x<A;x++)if(d(I=S[x],n,O,c,I)&&(f.push(x),i))return this.filteredrows=f,this.filterInitialized=!0,this}else for(x=0;x<A;x++)if(O((I=S[x])[n],c,I)&&(f.push(x),i))return this.filteredrows=f,this.filterInitialized=!0,this;return this.filteredrows=f,this.filterInitialized=!0,this},k.prototype.where=function(t){var e,i=[];if("function"!=typeof t)throw new TypeError("Argument is not a stored view or a function");e=t;try{if(this.filterInitialized){for(var r=this.filteredrows.length;r--;)!0===e(this.collection.data[this.filteredrows[r]])&&i.push(this.filteredrows[r]);return this.filteredrows=i,this}for(var n=this.collection.data.length;n--;)!0===e(this.collection.data[n])&&i.push(n);return this.filteredrows=i,this.filterInitialized=!0,this}catch(t){throw t}},k.prototype.count=function(){return this.filterInitialized?this.filteredrows.length:this.collection.count()},k.prototype.data=function(t){var e,i,r,n,o=[],s=this.collection.data;if((t=t||{}).removeMeta&&!t.forceClones&&(t.forceClones=!0,t.forceCloneMethod=t.forceCloneMethod||"shallow"),!this.collection.disableDeltaChangesApi&&this.collection.disableFreeze&&(t.forceClones=!0,t.forceCloneMethod="parse-stringify"),!this.filterInitialized){if(0===this.filteredrows.length){if(this.collection.cloneObjects||t.forceClones){for(i=s.length,n=t.forceCloneMethod||this.collection.cloneMethod,r=0;r<i;r++)e=m(s[r],n),t.removeMeta&&(delete e.$loki,delete e.meta),o.push(e);return o}return s.slice()}this.filterInitialized=!0}var a=this.filteredrows;if(i=a.length,this.collection.cloneObjects||t.forceClones)for(n=t.forceCloneMethod||this.collection.cloneMethod,r=0;r<i;r++)e=m(s[a[r]],n),t.removeMeta&&(delete e.$loki,delete e.meta),o.push(e);else for(r=0;r<i;r++)o.push(s[a[r]]);return o},k.prototype.update=function(t){if("function"!=typeof t)throw new TypeError("Argument is not a function");this.filterInitialized||0!==this.filteredrows.length||(this.filteredrows=this.collection.prepareFullDocIndex());for(var e,i=this.filteredrows.length,r=this.collection.data,n=0;n<i;n++)this.disableFreeze&&!this.collection.cloneObjects&&this.collection.disableDeltaChangesApi?(t(r[this.filteredrows[n]]),this.collection.update(r[this.filteredrows[n]])):(t(e=m(r[this.filteredrows[n]],this.collection.cloneMethod)),this.collection.update(e));return this},k.prototype.remove=function(){return this.filterInitialized||0!==this.filteredrows.length||(this.filteredrows=this.collection.prepareFullDocIndex()),this.collection.removeBatchByPositions(this.filteredrows),this.filteredrows=[],this},k.prototype.mapReduce=function(t,e){try{return e(this.data().map(t))}catch(t){throw t}},k.prototype.eqJoin=function(t,e,i,r,n){var o,s,a,l,c=[],h=[],u="function"==typeof e,p="function"==typeof i,d={};if(s=(o=this.data(n)).length,t instanceof P)c=t.chain().data(n);else if(t instanceof k)c=t.data(n);else{if(!Array.isArray(t))throw new TypeError("joinData needs to be an array or result set");c=t}a=c.length;for(var f=0;f<a;f++)d[l=p?i(c[f]):c[f][i]]=c[f];r||(r=function(t,e){return{left:t,right:e}});for(var y=0;y<s;y++)l=u?e(o[y]):o[y][e],h.push(r(o[y],d[l]||{}));return this.collection=new P("joinData"),this.collection.insert(h),this.filteredrows=[],this.filterInitialized=!1,this},k.prototype.map=function(t,e){var i=this.data(e).map(t);return this.collection=new P("mappedData"),this.collection.insert(i),this.filteredrows=[],this.filterInitialized=!1,this},D.prototype=new w,D.prototype.constructor=D,D.prototype.getSort=function(){return this.sortFunction||this.sortCriteria||this.sortCriteriaSimple},D.prototype.rematerialize=function(t){var e,i,r;t=t||{},this.resultdata=[],this.resultsdirty=!0,this.resultset=new k(this.collection),(this.sortFunction||this.sortCriteria||this.sortCriteriaSimple)&&(this.sortDirty=!0);var n=Object.isFrozen(this.filterPipeline);if(t.hasOwnProperty("removeWhereFilters"))for(n&&(this.filterPipeline=this.filterPipeline.slice()),i=e=this.filterPipeline.length;i--;)"where"===this.filterPipeline[i].type&&(i!==this.filterPipeline.length-1&&(this.filterPipeline[i]=this.filterPipeline[this.filterPipeline.length-1]),this.filterPipeline.length--);var o=this.filterPipeline;for(this.filterPipeline=[],e=o.length,r=0;r<e;r++)this.applyFind(o[r].val,o[r].uid);return n&&Object.freeze(this.filterPipeline),this.data(),this.emit("rebuild",this),this},D.prototype.branchResultset=function(t,e){var i=this.resultset.branch();return void 0===t?i:i.transform(t,e)},D.prototype.toJSON=function(){var t=new D(this.collection,this.name,this.options);return t.resultset=this.resultset,t.resultdata=[],t.resultsdirty=!0,t.filterPipeline=this.filterPipeline,t.sortFunction=this.sortFunction,t.sortCriteria=this.sortCriteria,t.sortCriteriaSimple=this.sortCriteriaSimple||null,t.sortDirty=this.sortDirty,t.collection=null,t},D.prototype.removeFilters=function(t){t=t||{},this.rebuildPending=!1,this.resultset.reset(),this.resultdata=[],this.resultsdirty=!0,this.cachedresultset=null;var e=Object.isFrozen(this.filterPipeline),i=this.filterPipeline.length>0;this.filterPipeline=[],e&&Object.freeze(this.filterPipeline),this.sortFunction=null,this.sortCriteria=null,this.sortCriteriaSimple=null,this.sortDirty=!1,!0===t.queueSortPhase&&this.queueSortPhase(),i&&this.emit("filter")},D.prototype.applySort=function(t){return this.sortFunction=t,this.sortCriteria=null,this.sortCriteriaSimple=null,this.queueSortPhase(),this.emit("sort"),this},D.prototype.applySimpleSort=function(t,i){return this.sortCriteriaSimple={propname:t,options:i||!1},this.collection.disableFreeze||e(this.sortCriteriaSimple),this.sortCriteria=null,this.sortFunction=null,this.queueSortPhase(),this.emit("sort"),this},D.prototype.applySortCriteria=function(t){return this.sortCriteria=t,this.collection.disableFreeze||e(this.sortCriteria),this.sortCriteriaSimple=null,this.sortFunction=null,this.queueSortPhase(),this.emit("sort"),this},D.prototype.startTransaction=function(){return this.cachedresultset=this.resultset.copy(),this},D.prototype.commit=function(){return this.cachedresultset=null,this},D.prototype.rollback=function(){return this.resultset=this.cachedresultset,this.options.persistent&&(this.resultdata=this.resultset.data(),this.emit("rebuild",this)),this},D.prototype._indexOfFilterWithId=function(t){if("string"==typeof t||"number"==typeof t)for(var e=0,i=this.filterPipeline.length;e<i;e+=1)if(t===this.filterPipeline[e].uid)return e;return-1},D.prototype._addFilter=function(t){var i=Object.isFrozen(this.filterPipeline);i&&(this.filterPipeline=this.filterPipeline.slice()),this.collection.disableFreeze||e(t),this.filterPipeline.push(t),i&&Object.freeze(this.filterPipeline),this.resultset[t.type](t.val)},D.prototype.reapplyFilters=function(){this.resultset.reset(),this.cachedresultset=null,this.options.persistent&&(this.resultdata=[],this.resultsdirty=!0);var t=this.filterPipeline,e=Object.isFrozen(t);this.filterPipeline=[];for(var i=0,r=t.length;i<r;i+=1)this._addFilter(t[i]);return e&&Object.freeze(this.filterPipeline),this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent(),this.emit("filter"),this},D.prototype.applyFilter=function(t){var e=this._indexOfFilterWithId(t.uid);if(e>=0){var i=Object.isFrozen(this.filterPipeline);return i&&(this.filterPipeline=this.filterPipeline.slice()),this.filterPipeline[e]=t,i&&(o(t),Object.freeze(this.filterPipeline)),this.reapplyFilters()}return this.cachedresultset=null,this.options.persistent&&(this.resultdata=[],this.resultsdirty=!0),this._addFilter(t),this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent(),this.emit("filter"),this},D.prototype.applyFind=function(t,e){return this.applyFilter({type:"find",val:t,uid:e}),this},D.prototype.applyWhere=function(t,e){return this.applyFilter({type:"where",val:t,uid:e}),this},D.prototype.removeFilter=function(t){var e=this._indexOfFilterWithId(t);if(e<0)throw new Error("Dynamic view does not contain a filter with ID: "+t);var i=Object.isFrozen(this.filterPipeline);return i&&(this.filterPipeline=this.filterPipeline.slice()),this.filterPipeline.splice(e,1),i&&Object.freeze(this.filterPipeline),this.reapplyFilters(),this},D.prototype.count=function(){return this.resultsdirty&&(this.resultdata=this.resultset.data()),this.resultset.count()},D.prototype.data=function(t){return(this.sortDirty||this.resultsdirty)&&this.performSortPhase({suppressRebuildEvent:!0}),this.options.persistent?this.resultdata:this.resultset.data(t)},D.prototype.queueRebuildEvent=function(){if(!this.rebuildPending){this.rebuildPending=!0;var t=this;setTimeout((function(){t.rebuildPending&&(t.rebuildPending=!1,t.emit("rebuild",t))}),this.options.minRebuildInterval)}},D.prototype.queueSortPhase=function(){if(!this.sortDirty){this.sortDirty=!0;var t=this;"active"===this.options.sortPriority?setTimeout((function(){t.performSortPhase()}),this.options.minRebuildInterval):this.queueRebuildEvent()}},D.prototype.performSortPhase=function(t){(this.sortDirty||this.resultsdirty)&&(t=t||{},this.sortDirty&&(this.sortFunction?this.resultset.sort(this.sortFunction):this.sortCriteria?this.resultset.compoundsort(this.sortCriteria):this.sortCriteriaSimple&&this.resultset.simplesort(this.sortCriteriaSimple.propname,this.sortCriteriaSimple.options),this.sortDirty=!1),this.options.persistent&&(this.resultdata=this.resultset.data(),this.resultsdirty=!1),t.suppressRebuildEvent||this.emit("rebuild",this))},D.prototype.evaluateDocument=function(t,e){if(!this.resultset.filterInitialized)return this.options.persistent&&(this.resultdata=this.resultset.data()),void(this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent());var i,r=this.resultset.filteredrows,n=e?-1:r.indexOf(+t),o=r.length,s=new k(this.collection);s.filteredrows=[t],s.filterInitialized=!0;for(var a=0,l=this.filterPipeline.length;a<l;a++)s[(i=this.filterPipeline[a]).type](i.val);var c=0===s.filteredrows.length?-1:0;return-1!==n||-1!==c?-1===n&&-1!==c?(r.push(t),this.options.persistent&&this.resultdata.push(this.collection.data[t]),void(this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent())):-1!==n&&-1===c?(n<o-1?(r.splice(n,1),this.options.persistent&&this.resultdata.splice(n,1)):(r.length=o-1,this.options.persistent&&(this.resultdata.length=o-1)),void(this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent())):-1!==n&&-1!==c?(this.options.persistent&&(this.resultdata[n]=this.collection.data[t]),void(this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent())):void 0:void 0},D.prototype.removeDocument=function(t){var e,i,r,n={},o={},s=[],a=this.resultset,l=this.resultset.filteredrows,c=l.length;if(!this.resultset.filterInitialized)return this.options.persistent&&(this.resultdata=this.resultset.data()),void(this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent());for(Array.isArray(t)||(t=[t]),r=t.length,i=0;i<r;i++)n[t[i]]=!0;for(e=0;e<c;e++)n[l[e]]&&(o[e]=!0);Object.keys(o).length>0&&(this.resultset.filteredrows=this.resultset.filteredrows.filter((function(t,e){return!o[e]})),this.options.persistent&&(this.resultdata=this.resultdata.filter((function(t,e){return!o[e]}))),this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent());var h=function(t){return function(e){return e<a.filteredrows[t]}};for(c=a.filteredrows.length,e=0;e<c;e++)s=t.filter(h(e)),a.filteredrows[e]-=s.length},D.prototype.mapReduce=function(t,e){try{return e(this.data().map(t))}catch(t){throw t}},P.prototype=new w,P.prototype.contructor=P,P.prototype.createChange=function(t,e,i,r){this.changes.push({name:t,operation:e,obj:"U"!=e||this.disableDeltaChangesApi?JSON.parse(JSON.stringify(i)):this.getChangeDelta(i,r)})},P.prototype.insertMeta=function(t){var e,i;if(!this.disableMeta&&t)if(Array.isArray(t))for(e=t.length,i=0;i<e;i++)t[i].hasOwnProperty("meta")||(t[i].meta={}),t[i].meta.created=(new Date).getTime(),t[i].meta.revision=0;else t.meta||(t.meta={}),t.meta.created=(new Date).getTime(),t.meta.revision=0},P.prototype.updateMeta=function(t){return this.disableMeta||!t||(this.disableFreeze||((t=s(t)).meta=s(t.meta)),t.meta.updated=(new Date).getTime(),t.meta.revision+=1),t},P.prototype.createInsertChange=function(t){this.createChange(this.name,"I",t)},P.prototype.createUpdateChange=function(t,e){this.createChange(this.name,"U",t,e)},P.prototype.insertMetaWithChange=function(t){this.insertMeta(t),this.createInsertChange(t)},P.prototype.updateMetaWithChange=function(t,e,i){return t=this.updateMeta(t,i),this.createUpdateChange(t,e),t},P.prototype.lokiConsoleWrapper={log:function(){},warn:function(){},error:function(){}},P.prototype.addAutoUpdateObserver=function(t){this.autoupdate&&"function"==typeof Object.observe&&Object.observe(t,this.observerCallback,["add","update","delete","reconfigure","setPrototype"])},P.prototype.removeAutoUpdateObserver=function(t){this.autoupdate&&"function"==typeof Object.observe&&Object.unobserve(t,this.observerCallback)},P.prototype.addTransform=function(t,e){if(this.transforms.hasOwnProperty(t))throw new Error("a transform by that name already exists");this.transforms[t]=e},P.prototype.getTransform=function(t){return this.transforms[t]},P.prototype.setTransform=function(t,e){this.transforms[t]=e},P.prototype.removeTransform=function(t){delete this.transforms[t]},P.prototype.byExample=function(t){var e,i,r;for(e in r=[],t)t.hasOwnProperty(e)&&r.push(((i={})[e]=t[e],i));return{$and:r}},P.prototype.findObject=function(t){return this.findOne(this.byExample(t))},P.prototype.findObjects=function(t){return this.find(this.byExample(t))},P.prototype.ttlDaemonFuncGen=function(){var t=this,e=this.ttl.age;return function(){var i=Date.now();t.chain().where((function(t){var r=t.meta.updated||t.meta.created;return e<i-r})).remove()}},P.prototype.setTTL=function(t,e){t<0?clearInterval(this.ttl.daemon):(this.ttl.age=t,this.ttl.ttlInterval=e,this.ttl.daemon=setInterval(this.ttlDaemonFuncGen(),e))},P.prototype.prepareFullDocIndex=function(){for(var t=this.data.length,e=new Array(t),i=0;i<t;i+=1)e[i]=i;return e},P.prototype.configureOptions=function(t){(t=t||{}).hasOwnProperty("adaptiveBinaryIndices")&&(this.adaptiveBinaryIndices=t.adaptiveBinaryIndices,this.adaptiveBinaryIndices&&this.ensureAllIndexes())},P.prototype.ensureIndex=function(t,e){if(void 0===e&&(e=!1),null==t)throw new Error("Attempting to set index without an associated property");if((!this.binaryIndices[t]||e||this.binaryIndices[t].dirty)&&(!0!==this.adaptiveBinaryIndices||!this.binaryIndices.hasOwnProperty(t)||e)){var i={name:t,dirty:!0,values:this.prepareFullDocIndex()};this.binaryIndices[t]=i;var r,n,o,s,c,h=(r=t,n=this.data,c=!!~r.indexOf(".")&&r.split("."),function(t,e){if(c?(o=a.getIn(n[t],c,!0),s=a.getIn(n[e],c,!0)):(o=n[t][r],s=n[e][r]),o!==s){if(l.lt(o,s,!1))return-1;if(l.gt(o,s,!1))return 1}return 0});i.values.sort(h),i.dirty=!1,this.dirty=!0}},P.prototype.checkAllIndexes=function(e){var i,r=this.binaryIndices,n=[];for(i in r)t.call(r,i)&&(this.checkIndex(i,e)||n.push(i));return n},P.prototype.checkIndex=function(t,e){(e=e||{}).randomSamplingFactor&&!1!==e.randomSampling&&(e.randomSampling=!0),e.randomSamplingFactor=e.randomSamplingFactor||.1,(e.randomSamplingFactor<0||e.randomSamplingFactor>1)&&(e.randomSamplingFactor=.1);var i,r,n,o,s,l=!0;if(!this.binaryIndices.hasOwnProperty(t))throw new Error("called checkIndex on property without an index: "+t);if(this.adaptiveBinaryIndices||this.ensureIndex(t),(o=(s=this.binaryIndices[t].values).length)!==this.data.length)return e.repair&&this.ensureIndex(t,!0),!1;if(0===o)return!0;var c=-1!==t.indexOf(".");if(1===o)l=0===s[0];else if(e.randomSampling){if(g.$lte(a.getIn(this.data[s[0]],t,c),a.getIn(this.data[s[1]],t,c))||(l=!1),g.$lte(a.getIn(this.data[s[o-2]],t,c),a.getIn(this.data[s[o-1]],t,c))||(l=!1),l)for(r=Math.floor((o-1)*e.randomSamplingFactor),i=0;i<r-1;i++)if(n=Math.floor(Math.random()*(o-1)),!g.$lte(a.getIn(this.data[s[n]],t,c),a.getIn(this.data[s[n+1]],t,c))){l=!1;break}}else for(i=0;i<o-1;i++)if(!g.$lte(a.getIn(this.data[s[i]],t,c),a.getIn(this.data[s[i+1]],t,c))){l=!1;break}return!l&&e.repair&&this.ensureIndex(t,!0),l},P.prototype.getBinaryIndexValues=function(t){var e,i=this.binaryIndices[t].values,r=[];for(e=0;e<i.length;e++)r.push(a.getIn(this.data[i[e]],t,!0));return r},P.prototype.getUniqueIndex=function(t,e){var i=this.constraints.unique[t];return!i&&e?this.ensureUniqueIndex(t):i},P.prototype.ensureUniqueIndex=function(t){var e=this.constraints.unique[t];return e||-1==this.uniqueNames.indexOf(t)&&this.uniqueNames.push(t),this.constraints.unique[t]=e=new F(t),this.data.forEach((function(t){e.set(t)})),e},P.prototype.ensureAllIndexes=function(e){var i,r=this.binaryIndices;for(i in r)t.call(r,i)&&this.ensureIndex(i,e)},P.prototype.flagBinaryIndexesDirty=function(){var e,i=this.binaryIndices;for(e in i)t.call(i,e)&&(i[e].dirty=!0)},P.prototype.flagBinaryIndexDirty=function(t){this.binaryIndices[t]&&(this.binaryIndices[t].dirty=!0)},P.prototype.count=function(t){return t?this.chain().find(t).filteredrows.length:this.data.length},P.prototype.ensureId=function(){if(!this.idIndex){for(var t=this.data,e=0,i=t.length,r=new Array(i);e<i;e++)r[e]=t[e].$loki;this.idIndex=r}},P.prototype.ensureIdAsync=function(t){this.async((function(){this.ensureId()}),t)},P.prototype.addDynamicView=function(t,e){var i=new D(this,t,e);return this.DynamicViews.push(i),i},P.prototype.removeDynamicView=function(t){this.DynamicViews=this.DynamicViews.filter((function(e){return e.name!==t}))},P.prototype.getDynamicView=function(t){for(var e=0;e<this.DynamicViews.length;e++)if(this.DynamicViews[e].name===t)return this.DynamicViews[e];return null},P.prototype.findAndUpdate=function(t,e){"function"==typeof t?this.updateWhere(t,e):this.chain().find(t).update(e)},P.prototype.findAndRemove=function(t){this.chain().find(t).remove()},P.prototype.insert=function(t,e){if(!Array.isArray(t))return this.insertOne(t);var i,r=[],n=e&&!this.cloneObjects&&this.adaptiveBinaryIndices&&Object.keys(this.binaryIndices).length>0;n&&(this.adaptiveBinaryIndices=!1);try{this.emit("pre-insert",t);for(var o=0,s=t.length;o<s;o++){if(!(i=this.insertOne(t[o],!0)))return;r.push(i)}}finally{n&&(this.ensureAllIndexes(),this.adaptiveBinaryIndices=!0)}return this.emit("insert",r),1===(r=this.cloneObjects?m(r,this.cloneMethod):r).length?r[0]:r},P.prototype.insertOne=function(t,i){var r,n=null;if("object"!=typeof t?n=new TypeError("Document needs to be an object"):null===t&&(n=new TypeError("Object cannot be null")),null!==n)throw this.emit("error",n),n;var o=this.cloneObjects?m(t,this.cloneMethod):t;if(this.disableFreeze||(o=s(o)),this.disableMeta||(void 0===o.meta?o.meta={revision:0,created:0}:this.disableFreeze||(o.meta=s(o.meta))),i||this.emit("pre-insert",o),this.add(o))return this.disableChangesApi?this.insertMeta(o):this.insertMetaWithChange(o),this.disableFreeze||e(o),r=this.cloneObjects?m(o,this.cloneMethod):o,i||this.emit("insert",r),this.addAutoUpdateObserver(r),r},P.prototype.clear=function(t){var e=this;t=t||{},this.data=[],this.idIndex=null,this.cachedIndex=null,this.cachedBinaryIndex=null,this.cachedData=null,this.maxId=0,this.DynamicViews=[],this.dirty=!0,this.constraints={unique:{},exact:{}},!0===t.removeIndices?(this.binaryIndices={},this.uniqueNames=[]):Object.keys(this.binaryIndices).forEach((function(t){e.binaryIndices[t].dirty=!1,e.binaryIndices[t].values=[]}))},P.prototype.update=function(i){var r,n,o;if(Array.isArray(i)){o=i.length,(r=!this.cloneObjects&&this.adaptiveBinaryIndices&&Object.keys(this.binaryIndices).length>0)&&(this.adaptiveBinaryIndices=!1);try{for(n=0;n<o;n+=1)this.update(i[n])}finally{r&&(this.ensureAllIndexes(),this.adaptiveBinaryIndices=!0)}}else{if(!t.call(i,"$loki"))throw new Error("Trying to update unsynced document. Please save the document first by using insert() or addMany()");try{this.startTransaction();var s,a,l,c,h,u=this.get(i.$loki,!0),p=this;if(!u)throw new Error("Trying to update a document not in collection.");s=u[0],l=u[1],a=this.cloneObjects||!this.disableDeltaChangesApi&&this.disableFreeze?m(i,this.cloneMethod):i,this.emit("pre-update",i),this.uniqueNames.forEach((function(t){p.getUniqueIndex(t,!0).update(s,a)})),this.data[l]=a,a!==i&&this.addAutoUpdateObserver(i);for(var d=0;d<this.DynamicViews.length;d++)this.DynamicViews[d].evaluateDocument(l,!1);if(this.adaptiveBinaryIndices){var f=this.binaryIndices;for(c in f)this.adaptiveBinaryIndexUpdate(l,c)}else this.flagBinaryIndexesDirty();return this.idIndex[l]=a.$loki,this.isIncremental&&this.dirtyIds.push(a.$loki),this.commit(),this.dirty=!0,a=this.disableChangesApi?this.updateMeta(a):this.updateMetaWithChange(a,s),this.disableFreeze||e(a),h=this.cloneObjects?m(a,this.cloneMethod):a,this.emit("update",h,s),h}catch(t){throw this.rollback(),this.lokiConsoleWrapper.error(t.message),this.emit("error",t),t}}},P.prototype.add=function(t){if("object"!=typeof t)throw new TypeError("Object being added needs to be an object");if(void 0!==t.$loki)throw new Error("Document is already in collection, please use update()");try{this.startTransaction(),this.maxId++,isNaN(this.maxId)&&(this.maxId=this.data[this.data.length-1].$loki+1);var e=this.maxId;t.$loki=e,this.disableMeta||(t.meta.version=0);for(var i=0,r=this.uniqueNames.length;i<r;i++)this.getUniqueIndex(this.uniqueNames[i],!0).set(t);this.idIndex&&this.idIndex.push(e),this.isIncremental&&this.dirtyIds.push(e),this.data.push(t);var n=this.data.length-1,o=this.DynamicViews.length;for(i=0;i<o;i++)this.DynamicViews[i].evaluateDocument(n,!0);if(this.adaptiveBinaryIndices){var s=this.binaryIndices;for(var a in s)this.adaptiveBinaryIndexInsert(n,a)}else this.flagBinaryIndexesDirty();return this.commit(),this.dirty=!0,this.cloneObjects?m(t,this.cloneMethod):t}catch(t){throw this.rollback(),this.lokiConsoleWrapper.error(t.message),this.emit("error",t),t}},P.prototype.updateWhere=function(t,e){var i,r=this.where(t),n=0;try{for(;n<r.length;n++)i=e(r[n]),this.update(i)}catch(t){this.rollback(),this.lokiConsoleWrapper.error(t.message)}},P.prototype.removeWhere=function(t){var e;"function"==typeof t?(e=this.data.filter(t),this.remove(e)):this.chain().find(t).remove()},P.prototype.removeDataOnly=function(){this.remove(this.data.slice())},P.prototype.removeBatchByPositions=function(t){var e,i,r,n,o=t.length,s={},a=Object.keys(this.binaryIndices).length,l=Object.keys(this.constraints.unique).length,c=this.adaptiveBinaryIndices&&Object.keys(this.binaryIndices).length>0,h=this;try{for(this.startTransaction(),this.ensureId(),r=0;r<o;r++)s[this.idIndex[t[r]]]=!0;if((e=this.DynamicViews.length)>0||a>0||l>0){if(e>0)for(i=0;i<e;i++)this.DynamicViews[i].removeDocument(t);if(this.adaptiveBinaryIndices&&!c){var u,p=this.binaryIndices;for(u in p)this.adaptiveBinaryIndexRemove(t,u)}else this.flagBinaryIndexesDirty();l&&this.uniqueNames.forEach((function(e){var i=h.getUniqueIndex(e);if(i)for(r=0;r<o;r++)null!==(n=h.data[t[r]])[e]&&void 0!==n[e]&&i.remove(n[e])}))}if(!this.disableChangesApi||this.events.delete.length>1)for(r=0;r<o;r++)this.emit("delete",this.data[t[r]]);if(this.data=this.data.filter((function(t){return!s[t.$loki]})),this.isIncremental)for(r=0;r<o;r++)this.dirtyIds.push(this.idIndex[t[r]]);this.idIndex=this.idIndex.filter((function(t){return!s[t]})),this.adaptiveBinaryIndices&&c&&(this.adaptiveBinaryIndices=!1,this.ensureAllIndexes(!0),this.adaptiveBinaryIndices=!0),this.commit(),this.dirty=!0}catch(t){return this.rollback(),c&&(this.adaptiveBinaryIndices=!0),this.lokiConsoleWrapper.error(t.message),this.emit("error",t),null}},P.prototype.removeBatch=function(t){var e,i=t.length,r=this.data.length,n={},o=[];for(e=0;e<r;e++)n[this.data[e].$loki]=e;for(e=0;e<i;e++)"object"==typeof t[e]?o.push(n[t[e].$loki]):o.push(n[t[e]]);this.removeBatchByPositions(o)},P.prototype.remove=function(e){if("number"==typeof e&&(e=this.get(e)),"object"!=typeof e)throw new Error("Parameter is not an object");if(Array.isArray(e))this.removeBatch(e);else{if(!t.call(e,"$loki"))throw new Error("Object is not a document stored in the collection");try{this.startTransaction();var i=this.get(e.$loki,!0),r=i[1],n=this;this.uniqueNames.forEach((function(t){if(null!==e[t]&&void 0!==e[t]){var i=n.getUniqueIndex(t);i&&i.remove(e[t])}}));for(var a=0;a<this.DynamicViews.length;a++)this.DynamicViews[a].removeDocument(r);if(this.adaptiveBinaryIndices){var l,c=this.binaryIndices;for(l in c)this.adaptiveBinaryIndexRemove(r,l)}else this.flagBinaryIndexesDirty();return this.data.splice(r,1),this.removeAutoUpdateObserver(e),this.idIndex.splice(r,1),this.isIncremental&&this.dirtyIds.push(e.$loki),this.commit(),this.dirty=!0,this.emit("delete",i[0]),this.disableFreeze||(e=s(e)),delete e.$loki,delete e.meta,this.disableFreeze||o(e),e}catch(t){return this.rollback(),this.lokiConsoleWrapper.error(t.message),this.emit("error",t),null}}},P.prototype.get=function(t,e){this.idIndex||this.ensureId();var i=e||!1,r=this.idIndex,n=r.length-1,o=0,s=o+n>>1;if(t="number"==typeof t?t:parseInt(t,10),isNaN(t))throw new TypeError("Passed id is not an integer");for(;r[o]<r[n];)r[s=o+n>>1]<t?o=s+1:n=s;return n===o&&r[o]===t?i?[this.data[o],o]:this.data[o]:null},P.prototype.getBinaryIndexPosition=function(t,e){var i=a.getIn(this.data[t],e,!0),r=this.binaryIndices[e].values,n=this.calculateRange("$eq",e,i);if(0===n[0]&&-1===n[1])return null;for(var o=n[0],s=n[1],l=o;l<=s;l++)if(r[l]===t)return l;return null},P.prototype.adaptiveBinaryIndexInsert=function(t,e){var i=-1!==e.indexOf("."),r=this.binaryIndices[e].values,n=a.getIn(this.data[t],e,i);!0===this.serializableIndices&&n instanceof Date&&(this.data[t][e]=n.getTime(),n=a.getIn(this.data[t],e));var o=0===r.length?0:this.calculateRangeStart(e,n,!0,i);this.binaryIndices[e].values.splice(o,0,t)},P.prototype.adaptiveBinaryIndexUpdate=function(t,e){var i,r=this.binaryIndices[e].values,n=r.length;for(i=0;i<n&&r[i]!==t;i++);this.binaryIndices[e].values.splice(i,1),this.adaptiveBinaryIndexInsert(t,e)},P.prototype.adaptiveBinaryIndexRemove=function(t,e,i){var r,n,o,s,a,l,c,h=this.binaryIndices[e],u={};if(Array.isArray(t)){if(1!==(s=t.length)){for(o=0;o<s;o++)u[t[o]]=!0;if(h.values=h.values.filter((function(t){return!u[t]})),!0===i)return;var p=t.slice();for(p.sort((function(t,e){return t-e})),r=h.values.length,n=0;n<r;n++){for(a=h.values[n],l=0,o=0;o<s&&a>p[o];o++)l++;h.values[n]-=l}return}t=t[0]}if(null===(c=this.getBinaryIndexPosition(t,e)))return null;if(h.values.splice(c,1),!0!==i)for(r=h.values.length,n=0;n<r;n++)h.values[n]>t&&h.values[n]--},P.prototype.calculateRangeStart=function(t,e,i,r){var n=this.data,o=this.binaryIndices[t].values,s=0,c=o.length-1,h=0;if(0===o.length)return-1;for(a.getIn(n[o[s]],t,r),a.getIn(n[o[c]],t,r);s<c;)h=s+c>>1,l.lt(a.getIn(n[o[h]],t,r),e,!1)?s=h+1:c=h;var u=s;return l.aeq(e,a.getIn(n[o[u]],t,r))?u:l.lt(e,a.getIn(n[o[u]],t,r),!1)?i?u:u-1:i?u+1:u},P.prototype.calculateRangeEnd=function(t,e,i){var r=this.data,n=this.binaryIndices[t].values,o=0,s=n.length-1,c=0;if(0===n.length)return-1;for(a.getIn(r[n[o]],t,i),a.getIn(r[n[s]],t,i);o<s;)c=o+s>>1,l.lt(e,a.getIn(r[n[c]],t,i),!1)?s=c:o=c+1;var h=s;return l.aeq(e,a.getIn(r[n[h]],t,i))?h:l.gt(e,a.getIn(r[n[h]],t,i),!1)?h+1:l.aeq(e,a.getIn(r[n[h-1]],t,i))?h-1:h},P.prototype.calculateRange=function(t,e,i){var r,n,o,s=this.data,c=this.binaryIndices[e].values,h=c.length-1;if(0===s.length)return[0,-1];var u=-1!==e.indexOf("."),p=a.getIn(s[c[0]],e,u),d=a.getIn(s[c[h]],e,u);switch(t){case"$eq":case"$aeq":case"$dteq":if(l.lt(i,p,!1)||l.gt(i,d,!1))return[0,-1];break;case"$gt":if(l.gt(i,d,!0))return[0,-1];if(l.gt(p,i,!1))return[0,h];break;case"$gte":if(l.gt(i,d,!1))return[0,-1];if(l.gt(p,i,!0))return[0,h];break;case"$lt":if(l.lt(i,p,!0))return[0,-1];if(l.lt(d,i,!1))return[0,h];break;case"$lte":if(l.lt(i,p,!1))return[0,-1];if(l.lt(d,i,!0))return[0,h];break;case"$between":return l.gt(i[0],d,!1)||l.lt(i[1],p,!1)?[0,-1]:((r=this.calculateRangeStart(e,i[0],!1,u))<0&&r++,(o=this.calculateRangeEnd(e,i[1],u))>h&&o--,l.gt(a.getIn(s[c[r]],e,u),i[0],!0)||r++,l.lt(a.getIn(s[c[o]],e,u),i[1],!0)||o--,o<r?[0,-1]:[r,o]);case"$in":for(var f=[],y=[],g=0,v=i.length;g<v;g++)for(var m=this.calculateRange("$eq",e,i[g]),b=m[0];b<=m[1];b++)void 0===f[b]&&(f[b]=!0,y.push(b));return y}switch(t){case"$eq":case"$aeq":case"$dteq":case"$gte":case"$lt":r=this.calculateRangeStart(e,i,!1,u),n=a.getIn(s[c[r]],e,u)}switch(t){case"$eq":case"$aeq":case"$dteq":case"$lte":case"$gt":o=this.calculateRangeEnd(e,i,u),a.getIn(s[c[o]],e,u)}switch(t){case"$eq":case"$aeq":case"$dteq":return l.aeq(n,i)?[r,o]:[0,-1];case"$gt":return l.aeq(a.getIn(s[c[o]],e,u),i)?[o+1,h]:[o,h];case"$gte":return l.aeq(a.getIn(s[c[r]],e,u),i)?[r,h]:[r+1,h];case"$lt":return l.aeq(a.getIn(s[c[r]],e,u),i)?[0,r-1]:[0,r];case"$lte":return l.aeq(a.getIn(s[c[o]],e,u),i)?[0,o]:[0,o-1];default:return[0,s.length-1]}},P.prototype.by=function(t,e){var i;if(void 0===e)return i=this,function(e){return i.by(t,e)};var r=this.getUniqueIndex(t,!0).get(e);return this.cloneObjects?m(r,this.cloneMethod):r},P.prototype.findOne=function(t){t=t||{};var e=this.chain().find(t,!0).data();return Array.isArray(e)&&0===e.length?null:this.cloneObjects?m(e[0],this.cloneMethod):e[0]},P.prototype.chain=function(t,e){var i=new k(this);return void 0===t?i:i.transform(t,e)},P.prototype.find=function(t){return this.chain().find(t).data()},P.prototype.findOneUnindexed=function(t,e){for(var i=this.data.length;i--;)if(a.getIn(this.data[i],t,!0)===e)return this.data[i];return null},P.prototype.startTransaction=function(){if(this.transactional){this.cachedData=m(this.data,this.cloneMethod),this.cachedIndex=this.idIndex,this.cachedBinaryIndex=this.binaryIndices,this.cachedDirtyIds=this.dirtyIds;for(var t=0;t<this.DynamicViews.length;t++)this.DynamicViews[t].startTransaction()}},P.prototype.commit=function(){if(this.transactional){this.cachedData=null,this.cachedIndex=null,this.cachedBinaryIndex=null,this.cachedDirtyIds=null;for(var t=0;t<this.DynamicViews.length;t++)this.DynamicViews[t].commit()}},P.prototype.rollback=function(){if(this.transactional){null!==this.cachedData&&null!==this.cachedIndex&&(this.data=this.cachedData,this.idIndex=this.cachedIndex,this.binaryIndices=this.cachedBinaryIndex,this.dirtyIds=this.cachedDirtyIds);for(var t=0;t<this.DynamicViews.length;t++)this.DynamicViews[t].rollback()}},P.prototype.async=function(t,e){setTimeout((function(){if("function"!=typeof t)throw new TypeError("Argument passed for async execution is not a function");t(),e()}),0)},P.prototype.where=function(t){return this.chain().where(t).data()},P.prototype.mapReduce=function(t,e){try{return e(this.data.map(t))}catch(t){throw t}},P.prototype.eqJoin=function(t,e,i,r,n){return new k(this).eqJoin(t,e,i,r,n)},P.prototype.stages={},P.prototype.getStage=function(t){return this.stages[t]||(this.stages[t]={}),this.stages[t]},P.prototype.commitLog=[],P.prototype.stage=function(t,e){var i=JSON.parse(JSON.stringify(e));return this.getStage(t)[e.$loki]=i,i},P.prototype.commitStage=function(t,e){var i,r=this.getStage(t),n=(new Date).getTime();for(i in r)this.update(r[i]),this.commitLog.push({timestamp:n,message:e,data:JSON.parse(JSON.stringify(r[i]))});this.stages[t]={}},P.prototype.no_op=function(){},P.prototype.extract=function(t){for(var e=0,i=this.data.length,r=C(t),n=[];e<i;e+=1)n.push(N(this.data[e],t,r));return n},P.prototype.max=function(t){return Math.max.apply(null,this.extract(t))},P.prototype.min=function(t){return Math.min.apply(null,this.extract(t))},P.prototype.maxRecord=function(t){for(var e,i=0,r=this.data.length,n=C(t),o={index:0,value:void 0};i<r;i+=1)void 0!==e?e<N(this.data[i],t,n)&&(e=N(this.data[i],t,n),o.index=this.data[i].$loki):(e=N(this.data[i],t,n),o.index=this.data[i].$loki);return o.value=e,o},P.prototype.minRecord=function(t){for(var e,i=0,r=this.data.length,n=C(t),o={index:0,value:void 0};i<r;i+=1)void 0!==e?e>N(this.data[i],t,n)&&(e=N(this.data[i],t,n),o.index=this.data[i].$loki):(e=N(this.data[i],t,n),o.index=this.data[i].$loki);return o.value=e,o},P.prototype.extractNumerical=function(t){return this.extract(t).map(E).filter(Number).filter((function(t){return!isNaN(t)}))},P.prototype.avg=function(t){return z(this.extractNumerical(t))},P.prototype.stdDev=function(t){return e=this.extractNumerical(t),i=z(e),r=z(e.map((function(t){var e=t-i;return e*e}))),Math.sqrt(r);var e,i,r},P.prototype.mode=function(t){var e,i,r,n={},o=this.extract(t);for(i in o.forEach((function(t){n[t]?n[t]+=1:n[t]=1})),n)e?e<n[i]&&(r=i):(r=i,e=n[i]);return r},P.prototype.median=function(t){var e=this.extractNumerical(t);e.sort($);var i=Math.floor(e.length/2);return e.length%2?e[i]:(e[i-1]+e[i])/2},R.prototype={keys:[],values:[],sort:function(t,e){return t<e?-1:t>e?1:0},setSort:function(t){this.bs=new M(t)},bs:function(){return new M(this.sort)},set:function(t,e){var i=this.bs(this.keys,t);i.found?this.values[i.index]=e:(this.keys.splice(i.index,0,t),this.values.splice(i.index,0,e))},get:function(t){return this.values[q(this.keys,t,this.sort).index]}},F.prototype.keyMap={},F.prototype.lokiMap={},F.prototype.set=function(t){var e=t[this.field];if(null!=e){if(this.keyMap[e])throw new Error("Duplicate key for property "+this.field+": "+e);this.keyMap[e]=t,this.lokiMap[t.$loki]=e}},F.prototype.get=function(t){return this.keyMap[t]},F.prototype.byId=function(t){return this.keyMap[this.lokiMap[t]]},F.prototype.update=function(t,e){if(this.lokiMap[t.$loki]!==e[this.field]){var i=this.lokiMap[t.$loki];this.set(e),this.keyMap[i]=void 0}else this.keyMap[t[this.field]]=e},F.prototype.remove=function(t){var e=this.keyMap[t];if(null==e)throw new Error("Key is not in unique index: "+this.field);this.keyMap[t]=void 0,this.lokiMap[e.$loki]=void 0},F.prototype.clear=function(){this.keyMap=Object.create(null),this.lokiMap=Object.create(null)},T.prototype={set:function(t,e){this.index[t]?this.index[t].push(e):this.index[t]=[e]},remove:function(t,e){var i=this.index[t];for(var r in i)i[r]==e&&i.splice(r,1);i.length<1&&(this.index[t]=void 0)},get:function(t){return this.index[t]},clear:function(t){this.index={}}},I.deepFreeze=e,I.freeze=o,I.unFreeze=s,I.LokiOps=g,I.Collection=P,I.DynamicView=D,I.Resultset=k,I.KeyValueStore=R,I.LokiMemoryAdapter=O,I.LokiPartitioningAdapter=S,I.LokiLocalStorageAdapter=A,I.LokiFsAdapter=x,I.persistenceAdapters={fs:x,localStorage:A},I.aeq=c,I.lt=h,I.gt=u,I.Comparators=l,I}()})?o.apply(e,s):o)||(t.exports=a)}).call(this,i(19),i(20))},function(t,e,i){t.exports={...i(8),...i(9),...i(10)}},function(t,e){t.exports={withContent:async t=>{let e=t.headers.get("content-type");t.content=void 0;try{e&&e.includes("application/json")&&(t.content=await t.json())}catch(t){}}}},function(t,e){t.exports={withCookies:t=>{t.cookies={};try{t.cookies=(t.headers.get("Cookie")||"").split(/;\s*/).map(t=>t.split("=")).reduce((t,[e,i])=>(t[e]=i,t),{})}catch(t){}}}},function(t,e){t.exports={withParams:t=>{for(const e in t.params||{})t[e]=t.params[e]}}},function(t,e){t.exports={createResponseType:(t="text/plain; charset=utf-8")=>(e,i={})=>{const{headers:r={},...n}=i;return"object"==typeof e?new Response(JSON.stringify(e),{headers:{"Content-Type":t,...r},...n}):new Response(e,i)}}},function(t,e,i){const{error:r}=i(5);t.exports={missing:(t="Not found.")=>r(404,t)}},function(t,e,i){const{json:r}=i(1);t.exports={status:(t,e)=>e?r({..."object"==typeof e?e:{status:t,message:e}},{status:t}):new Response(null,{status:t})}},function(t,e){t.exports={text:(t,e={})=>new Response(t,e)}},function(t,e,i){t.exports={...i(16)}},function(t,e,i){"use strict";const{Router:r}=i(2),{error:n}=i(4);t.exports={ThrowableRouter:(t={})=>{const{stack:e=!1}=t;return new Proxy(r(t),{get:(t,i)=>(...r)=>"handle"===i?t[i](...r).catch(t=>n(t.status||500,{status:t.status||500,error:t.message,stack:e&&t.stack||void 0})):t[i](...r)})}}},function(t,e,i){t.exports={...i(18)}},function(t,e){class i extends Error{constructor(t=500,e="Internal Error."){super(e),this.name="StatusError",this.status=t}}t.exports={StatusError:i}},function(t,e){var i;i=function(){return this}();try{i=i||new Function("return this")()}catch(t){"object"==typeof window&&(i=window)}t.exports=i},function(t,e){var i,r,n=t.exports={};function o(){throw new Error("setTimeout has not been defined")}function s(){throw new Error("clearTimeout has not been defined")}function a(t){if(i===setTimeout)return setTimeout(t,0);if((i===o||!i)&&setTimeout)return i=setTimeout,setTimeout(t,0);try{return i(t,0)}catch(e){try{return i.call(null,t,0)}catch(e){return i.call(this,t,0)}}}!function(){try{i="function"==typeof setTimeout?setTimeout:o}catch(t){i=o}try{r="function"==typeof clearTimeout?clearTimeout:s}catch(t){r=s}}();var l,c=[],h=!1,u=-1;function p(){h&&l&&(h=!1,l.length?c=l.concat(c):u=-1,c.length&&d())}function d(){if(!h){var t=a(p);h=!0;for(var e=c.length;e;){for(l=c,c=[];++u<e;)l&&l[u].run();u=-1,e=c.length}l=null,h=!1,function(t){if(r===clearTimeout)return clearTimeout(t);if((r===s||!r)&&clearTimeout)return r=clearTimeout,clearTimeout(t);try{r(t)}catch(e){try{return r.call(null,t)}catch(e){return r.call(this,t)}}}(t)}}function f(t,e){this.fun=t,this.array=e}function y(){}n.nextTick=function(t){var e=new Array(arguments.length-1);if(arguments.length>1)for(var i=1;i<arguments.length;i++)e[i-1]=arguments[i];c.push(new f(t,e)),1!==c.length||h||a(d)},f.prototype.run=function(){this.fun.apply(null,this.array)},n.title="browser",n.browser=!0,n.env={},n.argv=[],n.version="",n.versions={},n.on=y,n.addListener=y,n.once=y,n.off=y,n.removeListener=y,n.removeAllListeners=y,n.emit=y,n.prependListener=y,n.prependOnceListener=y,n.listeners=function(t){return[]},n.binding=function(t){throw new Error("process.binding is not supported")},n.cwd=function(){return"/"},n.chdir=function(t){throw new Error("process.chdir is not supported")},n.umask=function(){return 0}},function(t,e,i){var r,n,o;n=[],void 0===(o="function"==typeof(r=function(){return function(){function t(t,e){if(this.app="loki",this.options=e||{},void 0!==t&&(this.app=t),this.catalog=null,!this.checkAvailability())throw new Error("indexedDB does not seem to be supported for your environment")}function e(t){this.db=null,this.initializeLokiCatalog(t)}return t.prototype.closeDatabase=function(){this.catalog&&this.catalog.db&&(this.catalog.db.close(),this.catalog.db=null)},t.prototype.checkAvailability=function(){return!("undefined"==typeof indexedDB||!indexedDB)},t.prototype.loadDatabase=function(t,i){var r=this.app,n=this;null!==this.catalog&&null!==this.catalog.db?this.catalog.getAppKey(r,t,(function(t){if("function"==typeof i){if(0===t.id)return void i(null);i(t.val)}else console.log(t.val)})):this.catalog=new e((function(e){n.catalog=e,n.loadDatabase(t,i)}))},t.prototype.loadKey=t.prototype.loadDatabase,t.prototype.saveDatabase=function(t,i,r){var n=this.app,o=this;function s(t){t&&!0===t.success?r(null):r(new Error("Error saving database")),o.options.closeAfterSave&&o.closeDatabase()}null!==this.catalog&&null!==this.catalog.db?this.catalog.setAppKey(n,t,i,s):this.catalog=new e((function(e){o.saveDatabase(t,i,s)}))},t.prototype.saveKey=t.prototype.saveDatabase,t.prototype.deleteDatabase=function(t,i){var r=this.app,n=this;null!==this.catalog&&null!==this.catalog.db?this.catalog.getAppKey(r,t,(function(t){var e=t.id;0!==e?n.catalog.deleteAppKey(e,i):"function"==typeof i&&i({success:!0})})):this.catalog=new e((function(e){n.catalog=e,n.deleteDatabase(t,i)}))},t.prototype.deleteKey=t.prototype.deleteDatabase,t.prototype.deleteDatabasePartitions=function(t){var e=this;this.getDatabaseList((function(i){i.forEach((function(i){i.startsWith(t)&&e.deleteDatabase(i)}))}))},t.prototype.getDatabaseList=function(t){var i=this.app,r=this;null!==this.catalog&&null!==this.catalog.db?this.catalog.getAppKeys(i,(function(e){for(var i=[],r=0;r<e.length;r++)i.push(e[r].key);"function"==typeof t?t(i):i.forEach((function(t){console.log(t)}))})):this.catalog=new e((function(e){r.catalog=e,r.getDatabaseList(t)}))},t.prototype.getKeyList=t.prototype.getDatabaseList,t.prototype.getCatalogSummary=function(t){this.app;var i=this;null!==this.catalog&&null!==this.catalog.db?this.catalog.getAllKeys((function(e){for(var i,r,n,o,s,a=[],l=0;l<e.length;l++)n=(i=e[l]).app||"",o=i.key||"",s=i.val||"",r=2*n.length+2*o.length+s.length+1,a.push({app:i.app,key:i.key,size:r});"function"==typeof t?t(a):a.forEach((function(t){console.log(t)}))})):this.catalog=new e((function(e){i.catalog=e,i.getCatalogSummary(t)}))},e.prototype.initializeLokiCatalog=function(t){var e=indexedDB.open("LokiCatalog",1),i=this;e.onupgradeneeded=function(t){var e=t.target.result;if(e.objectStoreNames.contains("LokiAKV")&&e.deleteObjectStore("LokiAKV"),!e.objectStoreNames.contains("LokiAKV")){var i=e.createObjectStore("LokiAKV",{keyPath:"id",autoIncrement:!0});i.createIndex("app","app",{unique:!1}),i.createIndex("key","key",{unique:!1}),i.createIndex("appkey","appkey",{unique:!0})}},e.onsuccess=function(e){i.db=e.target.result,"function"==typeof t&&t(i)},e.onerror=function(t){throw t}},e.prototype.getAppKey=function(t,e,i){var r,n=t+","+e,o=this.db.transaction(["LokiAKV"],"readonly").objectStore("LokiAKV").index("appkey").get(n);o.onsuccess=(r=i,function(t){var e=t.target.result;null==e&&(e={id:0,success:!1}),"function"==typeof r?r(e):console.log(e)}),o.onerror=function(t){return function(e){if("function"!=typeof t)throw e;t({id:0,success:!1})}}(i)},e.prototype.getAppKeyById=function(t,e,i){this.db.transaction(["LokiAKV"],"readonly").objectStore("LokiAKV").get(t).onsuccess=function(t,e){return function(i){"function"==typeof e?e(i.target.result,t):console.log(i.target.result)}}(i,e)},e.prototype.setAppKey=function(t,e,i,r){var n,o=this.db.transaction(["LokiAKV"],"readwrite").objectStore("LokiAKV"),s=o.index("appkey"),a=t+","+e,l=s.get(a);l.onsuccess=function(n){var s=n.target.result;null==s?s={app:t,key:e,appkey:t+","+e,val:i}:s.val=i;var a,c=o.put(s);c.onerror=(a=r,function(t){"function"==typeof a?a({success:!1}):(console.error("LokiCatalog.setAppKey (set) onerror"),console.error(l.error))}),c.onsuccess=function(t){return function(e){"function"==typeof t&&t({success:!0})}}(r)},l.onerror=(n=r,function(t){"function"==typeof n?n({success:!1}):(console.error("LokiCatalog.setAppKey (get) onerror"),console.error(l.error))})},e.prototype.deleteAppKey=function(t,e){var i,r=this.db.transaction(["LokiAKV"],"readwrite").objectStore("LokiAKV").delete(t);r.onsuccess=(i=e,function(t){"function"==typeof i&&i({success:!0})}),r.onerror=function(t){return function(e){"function"==typeof t?t({success:!1}):(console.error("LokiCatalog.deleteAppKey raised onerror"),console.error(r.error))}}(e)},e.prototype.getAppKeys=function(t,e){var i,r=this.db.transaction(["LokiAKV"],"readonly").objectStore("LokiAKV").index("app"),n=IDBKeyRange.only(t),o=r.openCursor(n);o.onsuccess=function(t,e){return function(i){var r=i.target.result;if(r){var n=r.value;t.push(n),r.continue()}else"function"==typeof e?e(t):console.log(t)}}([],e),o.onerror=(i=e,function(t){"function"==typeof i?i(null):(console.error("LokiCatalog.getAppKeys raised onerror"),console.error(t))})},e.prototype.getAllKeys=function(t){var e,i=this.db.transaction(["LokiAKV"],"readonly").objectStore("LokiAKV").openCursor();i.onsuccess=function(t,e){return function(i){var r=i.target.result;if(r){var n=r.value;t.push(n),r.continue()}else"function"==typeof e?e(t):console.log(t)}}([],t),i.onerror=(e=t,function(t){"function"==typeof e&&e(null)})},t}()})?r.apply(e,n):r)||(t.exports=o)},function(t,e,i){"use strict";var r;i.r(e);var n=new Uint8Array(16);function o(){if(!r&&!(r="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return r(n)}var s=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;for(var a=function(t){return"string"==typeof t&&s.test(t)},l=[],c=0;c<256;++c)l.push((c+256).toString(16).substr(1));var h=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=(l[t[e+0]]+l[t[e+1]]+l[t[e+2]]+l[t[e+3]]+"-"+l[t[e+4]]+l[t[e+5]]+"-"+l[t[e+6]]+l[t[e+7]]+"-"+l[t[e+8]]+l[t[e+9]]+"-"+l[t[e+10]]+l[t[e+11]]+l[t[e+12]]+l[t[e+13]]+l[t[e+14]]+l[t[e+15]]).toLowerCase();if(!a(i))throw TypeError("Stringified UUID is invalid");return i};var u=function(t,e,i){var r=(t=t||{}).random||(t.rng||o)();if(r[6]=15&r[6]|64,r[8]=63&r[8]|128,e){i=i||0;for(var n=0;n<16;++n)e[i+n]=r[n];return e}return h(r)},p=i(2),d=i(0);var f=i(3),y=i.n(f),g=i(6);let v=new(i.n(g).a)("istrav"),m=v.addCollection("clients",{indices:["id","firebaseAuthRef"]}),b=v.addCollection("tenants",{indices:["id","slug"]});const w=API_KEYS_SECRET||"between workers";async function I(t,e){let i,r=e||m,n=await ISTRAV.get(t);return console.log("recover",n),n&&(i=JSON.parse(n),console.log("storageData",i),i.forEach(t=>{r.findAndRemove({id:t.id}),delete t.$loki,r.insert(t)})),i}async function O(t,e){let i=(e||m).find();console.log("memoryData",i);let r=JSON.stringify(i);return await ISTRAV.put(t,r),i}const S=Object(p.Router)();async function x(t){const{isValid:e,decoded:r,error:n}=await async function(t,e,r){if("undefined"!=typeof crypto&&crypto.subtle){const{verifyTokenIdWorker:n}=await i.e(1).then(i.bind(null,24));return await n(t,e,r)}return{isValid:!1,error:"SubtleCrypto not supported!",decoded:void 0}}(t,"https://securetoken.google.com/istrav","istrav");return console.log("isValid",e),e?r:{error:!0,message:n}}function A(t,e){let i=JSON.stringify(t);return new Response(i,{...e,headers:{"content-type":"application/json;charset=UTF-8","Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET,POST,PUT,DELETE,HEAD,OPTIONS","Access-Control-Allow-Headers":"content-type","Access-Control-Max-Age":"86400"}})}S.get("/:namespace",async({params:t})=>{let e="clients:"+t.namespace;await I(e);let i=m.find();return console.log("findAll",i),A(i)}),S.get("/:namespace/:id",async({params:t})=>{let e="clients:"+t.namespace;return await I(e),A(m.findOne({id:t.id}))}),S.post("/:namespace",d.withContent,async({params:t,content:e})=>{let i="clients:"+t.namespace;if(await I(i),await I("tenants:"+e.tenantId,b),e.id=u(),!await b.findOne({id:e.tenantId}))return A({error:"The provided tenent id foreign key does not exist."},{status:404});let r=m.insert(e);return await O(i),A(r)}),S.put("/:namespace/:id",d.withContent,async({params:t,content:e})=>{let i="clients:"+t.namespace;await I(i),await I("tenants:"+e.tenantId,b);let r=m.findOne({id:t.id});return r.email=e.email||r.email,r.firebaseAuthRef=e.firebaseAuthRef||r.firebaseAuthRef,r.tenantId=e.tenantId||r.tenantId,await b.findOne({id:r.tenantId})?(m.update(client),await O(i),A(r)):A({error:"The provided tenent id foreign key does not exist."},{status:404})}),S.delete("/:namespace/:id",async({params:t})=>{let e="clients:"+t.namespace;return await I(e),m.findAndRemove({id:t.id}),await O(e),A(null)}),S.post("/:namespace/verifyIdToken",d.withContent,async({params:t,content:e})=>{t.namespace;return e&&e.token?A(await x(e.token)):A({error:'A firebase token is required: { "token": "3r874ohs..." }.'},{status:400})}),S.post("/:namespace/register",d.withContent,async({params:t,content:e})=>{let i="clients:"+t.namespace;if(await I(i),!e||!e.token)return A({error:'A firebase token is required: { "token": "3r874ohs..." }.'},{status:400});let r=await x(e.token);if(console.log("verified",r),null===r)return A({error:e},{status:400});if(r.error)return A({error:r.message},{status:400});if(!r.payload.user_id)return A({error:"Token data does not have a firebaseAuthRef."},{status:404});if(m.findOne({firebaseAuthRef:r.payload.user_id}))return A({error:"A client with that firebaseAuthRef already exists."},{status:400});let n={id:u(),email:r.email,firebaseAuthRef:r.payload.user_id};console.log("record",n);let o=m.insert(n);console.log("client",o),await O(i);let s=await y.a.sign(o,w,{algorithm:"HS256"});return console.log("apiKey",s),s&&s!={}?A(s):A({error:"Sorry we are unable to generate an apiKey."},{status:400})}),S.post("/:namespace/login",d.withContent,async({params:t,content:e})=>{let i="clients:"+t.namespace;if(await I(i),!e||!e.token)return A({error:'A firebase token is required: { "token": "3r874ohs..." }.'},{status:400});let r=await x(e.token);if(console.log("verified",r),null===r)return A({error:e},{status:400});if(r.error)return A({error:r.message},{status:400});if(!r.payload.user_id)return A({error:"Token data does not have a firebaseAuthRef."},{status:404});let n=m.findOne({firebaseAuthRef:r.payload.user_id});if(console.log("client",n),!n)return A({error:"No client exists exist with that firebaseAuthRef."},{status:404});let o=await y.a.sign(n,w,{algorithm:"HS256"});return console.log("apiKey",o),o&&o!={}?A(o):A({error:"Sorry we are unable to generate an apiKey."},{status:400})}),S.all("*",()=>A("https://global.trabur.workers.dev")),addEventListener("fetch",t=>{t.respondWith(S.handle(t.request))})}]);